

{% assign widget_url = shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' %}
{% assign debug_mode = shop.metafields.nusense.debug_mode | default: false %}

<script>window.NUSENSE_CONFIG = {
widgetUrl: '{{ widget_url }}',
debug: {{ debug_mode }},
autoDetect: true,
shopDomain: '{{ shop.permanent_domain }}'
};
{% if product %}
{% assign product_images_from_media = product.media | where: 'media_type', 'image' %}
window.NUSENSE_PRODUCT_DATA = {
id: {{ product.id }},
title: {{ product.title | json }},
price: "{{ product.price | money }}",
priceRaw: {{ product.price | money_without_currency }},
images: [
{% if product_images_from_media.size > 0 %}
{% for media_item in product_images_from_media limit: 20 %}
{% assign image_url_full = media_item | image_url: width: 1200 %}
{% unless image_url_full contains '://' %}
{% assign image_url_full = 'https:' | append: image_url_full %}
{% endunless %}
{
id: {{ media_item.id }},
url: "{{ image_url_full }}"
}{% unless forloop.last %},{% endunless %}
{% endfor %}
{% else %}
{% for image in product.images limit: 20 %}
{% assign image_url_full = image | image_url: width: 1200 %}
{% unless image_url_full contains '://' %}
{% assign image_url_full = 'https:' | append: image_url_full %}
{% endunless %}
{
id: {{ image.id }},
url: "{{ image_url_full }}"
}{% unless forloop.last %},{% endunless %}
{% endfor %}
{% endif %}
],
recommendedProductsUrl: "{{ routes.product_recommendations_url }}?product_id={{ product.id }}&limit=10&intent=related",
description: {{ product.description | strip_html | truncate: 200 | json }},
variants: [
{% for variant in product.variants %}
{
id: {{ variant.id }},
title: {{ variant.title | json }},
price: "{{ variant.price | money }}",
priceRaw: {{ variant.price | money_without_currency }},
available: {{ variant.available | json }},
{% if variant.option1 %}option1: {{ variant.option1 | json }},{% endif %}
{% if variant.option2 %}option2: {{ variant.option2 | json }},{% endif %}
{% if variant.option3 %}option3: {{ variant.option3 | json }}{% endif %}
}{% unless forloop.last %},{% endunless %}
{% endfor %}
],
url: "{{ shop.url }}{{ product.url }}",
shop: {
name: {{ shop.name | json }},
domain: "{{ shop.permanent_domain }}"
}
};
{% endif %}
(function() {
if (!document.querySelector('script[src*="nusense-tryon-widget.js"]')) {
const script = document.createElement('script');
script.src = '{{ widget_url }}/nusense-tryon-widget.js';
script.async = true;
script.defer = true;
script.onload = function() {
};
script.onerror = function() {
};
document.head.appendChild(script);
}
})();</script>

<script>(function() {
const bannerId = 'nusense-tryon-availability-banner';
const bannerStyleId = 'nusense-tryon-availability-banner-styles';
const storageKey = 'nusenseTryOnBannerDismissed';
if (typeof window === 'undefined' || document.getElementById(bannerId)) {
return;
}
const isDismissed =
window.sessionStorage && window.sessionStorage.getItem(storageKey) === 'true';
if (isDismissed) {
return;
}
const isHomePath = (() => {
try {
const currentPath = (window.location.pathname || '/').trim();
var trailingSlashPattern = new RegExp('\\/+$');
const normalizedPath = currentPath.replace(trailingSlashPattern, '') || '/';
if (normalizedPath === '/' || normalizedPath === '') {
return true;
}
if (window.Shopify && window.Shopify.routes) {
var trailingSlashPattern2 = new RegExp('\\/+$');
const shopifyRoot = (window.Shopify.routes.root || '/').replace(trailingSlashPattern2, '') || '/';
if (normalizedPath === shopifyRoot) {
return true;
}
}
const homePatterns = ['/index', '/home', '/pages/home'];
if (homePatterns.some(pattern => normalizedPath === pattern || normalizedPath.startsWith(pattern + '/'))) {
return true;
}
const pathParts = normalizedPath.split('/').filter(Boolean);
if (pathParts.length === 0) {
return true;
}
return false;
} catch (e) {
return (window.location.pathname || '/').trim() === '/';
}
})();
if (!isHomePath) {
return;
}
const ensureStyles = () => {
if (document.getElementById(bannerStyleId)) {
return;
}
const style = document.createElement('style');
style.id = bannerStyleId;
style.textContent = `
#${bannerId} {
position: fixed;
top: 1.25rem;
right: 1rem;
z-index: 99999;
width: calc(100% - 2rem);
max-width: 20rem;
display: flex;
flex-direction: column;
gap: 0.75rem;
padding: 1rem 1.25rem 1rem 1rem;
border-radius: 1rem;
border: 1px solid rgba(255, 255, 255, 0.18);
background: linear-gradient(135deg, #101010, #1f1f1f);
color: #ffffff;
box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35);
opacity: 0;
transform: translateY(-12px);
transition: opacity 250ms ease, transform 250ms ease;
}
#${bannerId}.is-visible {
opacity: 1;
transform: translateY(0);
}
#${bannerId}.is-leaving {
opacity: 0;
transform: translateY(-10px);
}
#${bannerId} .nusense-banner-content {
display: flex;
flex-direction: column;
gap: 0.75rem;
position: relative;
}
#${bannerId} .nusense-banner-header {
display: flex;
align-items: flex-start;
}
#${bannerId} .nusense-banner-copy {
flex: 1;
}
#${bannerId} .nusense-banner-title {
font-size: 1rem;
font-weight: 700;
margin: 0;
}
#${bannerId} .nusense-banner-subtitle {
margin: 0.35rem 0 0;
font-size: 0.9rem;
color: rgba(255, 255, 255, 0.85);
line-height: 1.4;
}
@media (min-width: 640px) {
#${bannerId} {
right: 1.75rem;
width: auto;
max-width: 22rem;
}
}
@media (prefers-reduced-motion: reduce) {
#${bannerId} {
transition: opacity 200ms ease;
transform: none !important;
}
}
`;
document.head.appendChild(style);
};
const handleDismiss = (bannerElement) => {
if (!bannerElement) {
return;
}
if (bannerElement._autoCloseTimeout) {
clearTimeout(bannerElement._autoCloseTimeout);
bannerElement._autoCloseTimeout = null;
}
bannerElement.classList.add('is-leaving');
window.sessionStorage && window.sessionStorage.setItem(storageKey, 'true');
window.setTimeout(() => {
bannerElement.remove();
}, 220);
};
const createBanner = () => {
if (!document.body) {
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', createBanner, { once: true });
} else {
setTimeout(createBanner, 100);
}
return;
}
if (document.getElementById(bannerId)) {
return;
}
try {
ensureStyles();
const banner = document.createElement('div');
banner.id = bannerId;
banner.setAttribute('role', 'status');
banner.setAttribute('aria-live', 'polite');
banner.setAttribute('tabindex', '0');
banner.innerHTML = `
<div class="nusense-banner-content">
<div class="nusense-banner-header">
<div class="nusense-banner-copy">
<p class="nusense-banner-title">Essayage virtuel disponible</p>
<p class="nusense-banner-subtitle">
Découvrez notre nouvelle expérience Try-On immersive directement sur la page d'accueil.
</p>
</div>
</div>
</div>
`;
banner.addEventListener('keydown', (event) => {
if (event.key === 'Escape') {
handleDismiss(banner);
}
});
try {
if (document.body) {
document.body.appendChild(banner);
requestAnimationFrame(() => {
requestAnimationFrame(() => {
if (banner.parentNode) {
banner.classList.add('is-visible');
banner._autoCloseTimeout = setTimeout(() => {
handleDismiss(banner);
}, 10000);
}
});
});
} else {
setTimeout(() => {
try {
if (document.body && banner) {
document.body.appendChild(banner);
if (banner.parentNode) {
banner.classList.add('is-visible');
banner._autoCloseTimeout = setTimeout(() => {
handleDismiss(banner);
}, 10000);
}
}
} catch (retryError) {
}
}, 100);
}
} catch (appendError) {
}
} catch (e) {
console.error('NUSENSE: Failed to create banner', e);
}
};
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', createBanner, { once: true });
} else {
if (document.body) {
createBanner();
} else {
setTimeout(createBanner, 50);
}
}
})();</script>

<script>
// CRITICAL: This script MUST execute immediately and synchronously
// Add a log at the very top to verify script execution
console.log('NUSENSE: Script file loaded and executing');
(function() {
'use strict';
// Prevent duplicate initialization
if (window.NUSENSE_IMAGE_LISTENER_INITIALIZED) {
console.log('NUSENSE: Script already initialized, skipping');
return;
}
window.NUSENSE_IMAGE_LISTENER_INITIALIZED = true;
console.log('NUSENSE: Initializing image listener script');
const CONFIG = {
debug: {{ debug_mode | default: false }},
allowedOrigins: ['*'],
widgetUrl: '{{ widget_url | default: "https://try-this-look.vercel.app" }}'
};
function log(message, data) {
}
function isValidOrigin(origin) {
if (CONFIG.allowedOrigins.includes('*')) {
return true;
}
try {
const widgetUrlObj = new URL(CONFIG.widgetUrl);
return origin === widgetUrlObj.origin;
} catch (e) {
return false;
}
}
function ensureAbsoluteUrl(url) {
if (!url || typeof url !== 'string') return null;
// Use RegExp constructor to avoid Liquid template issues with regex literals
var httpsPattern = new RegExp('^https?:\\/\\/');
if (httpsPattern.test(url)) {
return url;
}
var protocolRelativePattern = new RegExp('^\\/\\/');
if (protocolRelativePattern.test(url)) {
return 'https:' + url;
}
try {
return new URL(url, window.location.origin).href;
} catch (e) {
return url;
}
}
function extractFromShopifyJSON() {
const images = [];
try {
const scripts = document.querySelectorAll('script[type="application/json"]');
for (const script of scripts) {
try {
const data = JSON.parse(script.textContent || '{}');
if (data.product && data.product.media) {
const media = data.product.media;
if (Array.isArray(media)) {
media.forEach(function(item) {
if (item.media_type === 'image' || !item.media_type) {
let imgUrl = null;
if (item.preview && item.preview.image && item.preview.image.src) {
imgUrl = item.preview.image.src;
} else if (item.src) {
imgUrl = item.src;
} else if (item.url) {
imgUrl = item.url;
}
if (imgUrl) {
imgUrl = ensureAbsoluteUrl(imgUrl);
if (imgUrl && images.indexOf(imgUrl) === -1) images.push(imgUrl);
}
} else if (item.preview_image && item.preview_image.src) {
const imgUrl = ensureAbsoluteUrl(item.preview_image.src);
if (imgUrl && images.indexOf(imgUrl) === -1) images.push(imgUrl);
}
});
if (images.length > 0) {
log('Extracted images from Shopify media array', images.length);
return images;
}
}
}
if (data.product && data.product.images) {
const productImages = data.product.images;
if (Array.isArray(productImages)) {
productImages.forEach(function(img) {
let imgUrl = null;
if (typeof img === 'string') {
imgUrl = img;
} else if (img.src) {
imgUrl = img.src;
} else if (img.url) {
imgUrl = img.url;
} else if (img.originalSrc) {
imgUrl = img.originalSrc;
}
if (imgUrl) {
imgUrl = ensureAbsoluteUrl(imgUrl);
if (imgUrl && images.indexOf(imgUrl) === -1) images.push(imgUrl);
}
});
if (images.length > 0) {
log('Extracted images from Shopify JSON images array', images.length);
return images;
}
}
}
} catch (e) {
}
}
if (typeof window.Shopify !== 'undefined' && window.Shopify.product) {
if (window.Shopify.product.media) {
window.Shopify.product.media.forEach(function(item) {
if (item.media_type === 'image' || !item.media_type) {
let imgUrl = null;
if (item.src) imgUrl = item.src;
else if (item.url) imgUrl = item.url;
else if (item.preview_image && item.preview_image.src) imgUrl = item.preview_image.src;
if (imgUrl) {
imgUrl = ensureAbsoluteUrl(imgUrl);
if (imgUrl && images.indexOf(imgUrl) === -1) images.push(imgUrl);
}
}
});
}
if (images.length === 0 && window.Shopify.product.images) {
window.Shopify.product.images.forEach(function(img) {
let imgUrl = null;
if (typeof img === 'string') {
imgUrl = img;
} else if (img.src) {
imgUrl = img.src;
}
if (imgUrl) {
imgUrl = ensureAbsoluteUrl(imgUrl);
if (imgUrl && images.indexOf(imgUrl) === -1) images.push(imgUrl);
}
});
}
if (images.length > 0) {
log('Extracted images from window.Shopify.product', images.length);
return images;
}
}
} catch (e) {
log('Error extracting from Shopify JSON', e);
}
return images;
}
function extractFromDOM() {
const images = [];
const seenUrls = new Set();
try {
const selectors = [
'.product__media img',
'.product-image img',
'.product-gallery img',
'.product-photos img',
'.product__media-wrapper img',
'.product-single__media img',
'[data-product-image] img',
'[data-product-single-media-group] img',
'.product-images img',
'.product-media img'
];
selectors.forEach(function(selector) {
const elements = document.querySelectorAll(selector);
elements.forEach(function(img) {
if (img instanceof HTMLImageElement) {
const sources = [
img.src,
img.dataset.src,
img.dataset.lazySrc,
img.dataset.originalSrc,
img.currentSrc
].filter(Boolean);
sources.forEach(function(src) {
if (src && !seenUrls.has(src)) {
// Use RegExp constructor to avoid Liquid template issues
var imageExtPattern = new RegExp('\\.(jpg|jpeg|png|webp|gif|avif)(\\?|$)', 'i');
if (imageExtPattern.test(src)) {
const absUrl = ensureAbsoluteUrl(src);
if (absUrl) {
images.push(absUrl);
seenUrls.add(absUrl);
seenUrls.add(src);
}
}
}
});
}
});
});
if (images.length > 0) {
log('Extracted images from DOM', images.length);
}
} catch (e) {
log('Error extracting from DOM', e);
}
return images;
}
function getRecommendedProductsImages(mainProductImages) {
const allImages = [];
const seenUrls = new Set();
const seenNormalizedUrls = new Set();
const mainProductImageSet = new Set();
const mainProductImageBasePaths = new Set();
function getBaseImagePath(url) {
try {
const urlObj = new URL(url, window.location.origin);
urlObj.search = '';
urlObj.hash = '';
const path = urlObj.pathname;
const pathParts = path.split('/');
const filename = pathParts[pathParts.length - 1];
if (pathParts.length >= 2) {
const shortPath = pathParts.slice(-2).join('/');
return shortPath.toLowerCase();
}
return filename.toLowerCase();
} catch (e) {
return null;
}
}
function normalizeUrlForComparison(url) {
try {
const urlObj = new URL(url, window.location.origin);
urlObj.search = '';
urlObj.hash = '';
return urlObj.href.toLowerCase();
} catch (e) {
return null;
}
}
if (mainProductImages && Array.isArray(mainProductImages)) {
mainProductImages.forEach(function(img) {
try {
const normalized = ensureAbsoluteUrl(img);
if (normalized) {
mainProductImageSet.add(normalized.toLowerCase());
const normalizedForComparison = normalizeUrlForComparison(normalized);
if (normalizedForComparison) {
mainProductImageSet.add(normalizedForComparison);
}
const basePath = getBaseImagePath(normalized);
if (basePath) {
mainProductImageBasePaths.add(basePath);
}
try {
const originalNormalized = normalizeUrlForComparison(img);
if (originalNormalized && originalNormalized !== normalizedForComparison) {
mainProductImageSet.add(originalNormalized);
}
} catch (e) {}
} else {
try {
const normalizedForComparison = normalizeUrlForComparison(img);
if (normalizedForComparison) {
mainProductImageSet.add(normalizedForComparison);
}
const basePath = getBaseImagePath(img);
if (basePath) {
mainProductImageBasePaths.add(basePath);
}
} catch (e) {}
}
} catch (e) {
try {
const normalizedForComparison = normalizeUrlForComparison(img);
if (normalizedForComparison) {
mainProductImageSet.add(normalizedForComparison);
}
const basePath = getBaseImagePath(img);
if (basePath) {
mainProductImageBasePaths.add(basePath);
}
} catch (e) {}
}
});
}
function addImage(url) {
if (!url) return;
try {
const cleanUrl = ensureAbsoluteUrl(url);
const urlToCheck = cleanUrl || url;
const normalizedForComparison = normalizeUrlForComparison(urlToCheck);
if (!normalizedForComparison) return;
if (seenNormalizedUrls.has(normalizedForComparison)) {
return;
}
if (seenUrls.has(urlToCheck.toLowerCase())) {
return;
}
let isMainProductImage = false;
if (mainProductImageSet.has(urlToCheck.toLowerCase()) ||
mainProductImageSet.has(normalizedForComparison) ||
mainProductImageSet.has(url.toLowerCase())) {
isMainProductImage = true;
}
if (!isMainProductImage) {
const basePath = getBaseImagePath(urlToCheck);
if (basePath && mainProductImageBasePaths.has(basePath)) {
isMainProductImage = true;
}
}
if (!isMainProductImage && mainProductImages && mainProductImages.length > 0) {
const currentBasePath = getBaseImagePath(urlToCheck);
if (currentBasePath) {
for (var i = 0; i < mainProductImages.length; i++) {
const mainImg = mainProductImages[i];
const mainBasePath = getBaseImagePath(mainImg);
if (mainBasePath && mainBasePath === currentBasePath) {
isMainProductImage = true;
break;
}
}
}
}
if (isMainProductImage) {
return;
}
// Use RegExp constructor to avoid Liquid template issues
var imageExtPattern = new RegExp('\\.(jpg|jpeg|png|webp|gif|avif)(\\?|$)', 'i');
if (imageExtPattern.test(urlToCheck)) {
const lowerUrl = urlToCheck.toLowerCase();
const excludePatterns = [
'logo', 'icon', 'badge', 'payment', 'trust', 'review', 'star',
'avatar', 'user', 'profile', 'social', 'facebook', 'twitter',
'instagram', 'pinterest', 'google', 'analytics', 'tracking',
'pixel', 'spacer', 'blank', 'placeholder', '1x1', 'pixel.gif',
'transparent', '.svg'
];
const shouldExclude = excludePatterns.some(function(pattern) {
return lowerUrl.includes(pattern);
});
if (shouldExclude) return;
allImages.push(urlToCheck);
seenUrls.add(urlToCheck.toLowerCase());
seenUrls.add(url.toLowerCase());
seenNormalizedUrls.add(normalizedForComparison);
}
} catch (e) {
}
}
try {
const allImgElements = document.querySelectorAll('img');
allImgElements.forEach(function(img) {
if (img instanceof HTMLImageElement) {
const sources = [
img.src,
img.dataset.src,
img.dataset.lazySrc,
img.dataset.originalSrc,
img.dataset.productImage,
img.currentSrc,
img.getAttribute('data-original'),
img.getAttribute('data-lazy')
].filter(Boolean);
if (img.srcset) {
const srcsetEntries = img.srcset.split(',');
srcsetEntries.forEach(function(entry) {
var whitespacePattern = new RegExp('\\s+');
const parts = entry.trim().split(whitespacePattern);
if (parts[0]) {
sources.push(parts[0]);
}
});
}
sources.forEach(function(src) {
addImage(src);
});
}
});
const bgImageElements = document.querySelectorAll('[style*="background-image"]');
bgImageElements.forEach(function(el) {
const style = window.getComputedStyle(el);
const bgImage = style.backgroundImage;
if (bgImage && bgImage !== 'none') {
var urlMatchPattern = new RegExp('url\\([\'"]?([^\'"]+)[\'"]?\\)');
const urlMatch = bgImage.match(urlMatchPattern);
if (urlMatch && urlMatch[1]) {
addImage(urlMatch[1]);
}
}
});
} catch (e) {
}
return allImages;
}
function getProductImages() {
let images = [];
// Priority 1: Use NUSENSE_PRODUCT_DATA (set by Liquid template)
{% if product %}
if (window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.images && Array.isArray(window.NUSENSE_PRODUCT_DATA.images)) {
images = window.NUSENSE_PRODUCT_DATA.images.filter(function(img) {
if (typeof img === 'string') {
return img && img.trim().length > 0;
} else if (img && typeof img === 'object' && img.url) {
return img.url && typeof img.url === 'string' && img.url.trim().length > 0;
}
return false;
});
if (images.length > 0) {
console.log('NUSENSE: Found', images.length, 'images from NUSENSE_PRODUCT_DATA');
return images;
} else {
console.warn('NUSENSE: NUSENSE_PRODUCT_DATA.images exists but is empty or filtered out');
}
} else {
console.warn('NUSENSE: NUSENSE_PRODUCT_DATA not found or images not available');
}
{% endif %}
// Priority 2: Extract from Shopify JSON scripts
images = extractFromShopifyJSON();
if (images.length > 0) {
console.log('NUSENSE: Found', images.length, 'images from Shopify JSON');
// Convert string URLs to object format for consistency
return images.map(function(url) {
return typeof url === 'string' ? { url: url } : url;
});
}
// Priority 3: Extract from DOM
images = extractFromDOM();
if (images.length > 0) {
console.log('NUSENSE: Found', images.length, 'images from DOM');
// Convert string URLs to object format for consistency
return images.map(function(url) {
return typeof url === 'string' ? { url: url } : url;
});
}
console.warn('NUSENSE: No images found from any source');
return [];
}
function handleWidgetAction(actionType, event) {
{% if product %}
const productForm = document.querySelector('form[action*="/cart/add"]');
const variantSelector = document.querySelector('[name="id"]') || document.querySelector('input[name="id"]') || document.querySelector('select[name="id"]');
let variantId = null;
if (variantSelector) {
variantId = variantSelector.value;
} else if (window.Shopify && window.Shopify.product) {
const variants = window.Shopify.product.variants || [];
const availableVariant = variants.find(function(v) { return v.available; });
if (availableVariant) {
variantId = availableVariant.id;
} else if (variants.length > 0) {
variantId = variants[0].id;
}
}
if (!variantId && productForm) {
const formVariantId = new FormData(productForm).get('id');
if (formVariantId) {
variantId = formVariantId;
}
}
if (!variantId && window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.variants && window.NUSENSE_PRODUCT_DATA.variants.length > 0) {
const availableVariant = window.NUSENSE_PRODUCT_DATA.variants.find(function(v) { return v.available !== false; });
if (availableVariant) {
variantId = availableVariant.id;
} else {
variantId = window.NUSENSE_PRODUCT_DATA.variants[0].id;
}
}
if (!variantId) {
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_ERROR',
action: actionType,
error: 'No variant selected. Please select a product variant.'
}, '*');
}
return;
}
const cartAddUrl = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root)
? window.Shopify.routes.root + 'cart/add.js'
: '/cart/add.js';
const quantity = productForm ? (new FormData(productForm).get('quantity') || 1) : 1;
const cartData = {
items: [{
id: parseInt(variantId, 10),
quantity: parseInt(quantity, 10) || 1
}]
};
if (productForm) {
const formData = new FormData(productForm);
const properties = {};
for (const [key, value] of formData.entries()) {
if (key.startsWith('properties[') && key.endsWith(']')) {
var propKeyPattern = new RegExp('properties\\[(.*?)\\]');
const propKeyMatch = key.match(propKeyPattern);
if (propKeyMatch && propKeyMatch[1]) {
const propKey = propKeyMatch[1];
properties[propKey] = value;
}
}
}
if (Object.keys(properties).length > 0) {
cartData.items[0].properties = properties;
}
}
switch (actionType) {
case 'NUSENSE_BUY_NOW':
fetch(cartAddUrl, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(cartData)
})
.then(function(response) {
return response.json().then(function(data) {
if (response.ok) {
const checkoutUrl = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root)
? window.Shopify.routes.root + 'checkout'
: '/checkout';
window.location.href = checkoutUrl;
} else {
const errorMessage = data.description || data.message || 'Failed to add product to cart';
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_ERROR',
action: actionType,
error: errorMessage
}, '*');
}
const cartUrl = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root)
? window.Shopify.routes.root + 'cart'
: '/cart';
window.location.href = cartUrl;
}
});
})
.catch(function(error) {
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_ERROR',
action: actionType,
error: 'Network error. Please try again.'
}, '*');
}
const cartUrl = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root)
? window.Shopify.routes.root + 'cart'
: '/cart';
window.location.href = cartUrl;
});
break;
case 'NUSENSE_ADD_TO_CART':
fetch(cartAddUrl, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(cartData)
})
.then(function(response) {
return response.json().then(function(data) {
if (response.ok) {
if (typeof window.dispatchEvent !== 'undefined') {
window.dispatchEvent(new CustomEvent('cart:updated'));
window.dispatchEvent(new CustomEvent('cart:add', { detail: data }));
}
if (typeof window.theme !== 'undefined' && typeof window.theme.cart !== 'undefined') {
if (typeof window.theme.cart.getCart === 'function') {
window.theme.cart.getCart();
}
}
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_SUCCESS',
action: actionType,
cart: data
}, '*');
}
} else {
const errorMessage = data.description || data.message || 'Failed to add product to cart';
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_ERROR',
action: actionType,
error: errorMessage
}, '*');
}
}
});
})
.catch(function(error) {
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_ERROR',
action: actionType,
error: 'Network error. Please try again.'
}, '*');
}
});
break;
case 'NUSENSE_TRY_IN_STORE':
if (event.source && event.source !== window) {
event.source.postMessage({
type: 'NUSENSE_ACTION_INFO',
action: actionType,
message: 'Try in store functionality - to be configured for your store'
}, '*');
}
break;
default:
}
{% else %}
{% endif %}
}
function handleMessage(event) {
if (!event.data || !event.data.type || !event.data.type.startsWith('NUSENSE_')) {
return;
}
console.log('NUSENSE: Message received', {
type: event.data.type,
hasSource: !!event.source,
sourceIsWindow: event.source === window,
origin: event.origin
});
try {
if (event.data && event.data.type === 'NUSENSE_REQUEST_STORE_INFO') {
console.log('NUSENSE: Handling NUSENSE_REQUEST_STORE_INFO');
if (event.source && event.source !== window) {
const storeInfo = {
type: 'NUSENSE_STORE_INFO',
domain: window.location.hostname,
shopDomain: '{{ shop.permanent_domain }}',
origin: window.location.origin,
fullUrl: window.location.href
};
event.source.postMessage(storeInfo, '*');
console.log('NUSENSE: Store info sent');
}
return;
}
if (event.data && event.data.type === 'NUSENSE_REQUEST_IMAGES') {
console.log('NUSENSE: Handling NUSENSE_REQUEST_IMAGES', {
hasSource: !!event.source,
sourceIsWindow: event.source === window,
origin: event.origin
});
// Verify the request is from an iframe (not from the same window)
if (event.source && event.source !== window) {
// If script is not fully initialized yet, queue the request
if (!window.NUSENSE_MESSAGE_LISTENER_ACTIVE) {
console.log('NUSENSE: Script not ready, queueing image request');
window.NUSENSE_PENDING_IMAGE_REQUESTS = window.NUSENSE_PENDING_IMAGE_REQUESTS || [];
window.NUSENSE_PENDING_IMAGE_REQUESTS.push(event);
// Set up listener immediately
if (!window.NUSENSE_MESSAGE_LISTENER_ACTIVE) {
window.addEventListener('message', handleMessage);
window.NUSENSE_MESSAGE_LISTENER_ACTIVE = true;
console.log('NUSENSE: Message listener set up from pending request');
}
// Process immediately after setup
setTimeout(function() {
handleImageRequest(event);
}, 0);
} else {
handleImageRequest(event);
}
} else {
console.warn('NUSENSE: NUSENSE_REQUEST_IMAGES received but event.source is invalid', {
hasSource: !!event.source,
sourceIsWindow: event.source === window,
origin: event.origin
});
}
return;
}
if (event.data && event.data.type && (
event.data.type === 'NUSENSE_BUY_NOW' ||
event.data.type === 'NUSENSE_ADD_TO_CART' ||
event.data.type === 'NUSENSE_TRY_IN_STORE'
)) {
handleWidgetAction(event.data.type, event);
return;
}
} catch (error) {
if (CONFIG && CONFIG.debug) {
console.error('NUSENSE: Error in message handler:', error);
}
}
}
function handleImageRequest(event) {
// Always respond to image requests, even if no images found
const images = getProductImages();
const recommendedImages = getRecommendedProductsImages(images);

console.log('NUSENSE: handleImageRequest called', {
imageCount: images.length,
recommendedCount: recommendedImages.length,
hasEventSource: !!event.source,
eventSourceIsWindow: event.source === window
});

// Verify we have a valid event source (the iframe)
if (!event.source || event.source === window) {
console.warn('NUSENSE: Invalid event source in handleImageRequest');
return; // Invalid request source
}

try {
const message = {
type: 'NUSENSE_PRODUCT_IMAGES',
images: images,
recommendedImages: recommendedImages
};
console.log('NUSENSE: Sending images to widget', {
imageCount: images.length,
recommendedCount: recommendedImages.length,
firstImage: images.length > 0 ? (typeof images[0] === 'string' ? images[0] : images[0].url) : null
});
event.source.postMessage(message, '*');
console.log('NUSENSE: Images sent successfully');
} catch (e) {
console.error('NUSENSE: Failed to send images to widget', e);
// Failed to send message - iframe might have been closed
}
}
// Set up message listener immediately - must be ready before widget requests images
if (!window.NUSENSE_MESSAGE_LISTENER_ACTIVE) {
window.addEventListener('message', handleMessage);
window.NUSENSE_MESSAGE_LISTENER_ACTIVE = true;
console.log('NUSENSE: Message listener set up');
} else {
console.log('NUSENSE: Message listener already active');
}

// Ensure message listener is set up even if DOM is still loading
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', function() {
// Listener already set up above, just ensure it's active
if (!window.NUSENSE_MESSAGE_LISTENER_ACTIVE) {
window.addEventListener('message', handleMessage);
window.NUSENSE_MESSAGE_LISTENER_ACTIVE = true;
console.log('NUSENSE: Message listener set up on DOMContentLoaded');
}
});
}

// Log NUSENSE_PRODUCT_DATA availability for debugging
{% if product %}
// Check immediately and also after a short delay to catch late-loading data
if (window.NUSENSE_PRODUCT_DATA) {
console.log('NUSENSE: NUSENSE_PRODUCT_DATA available immediately', {
productId: window.NUSENSE_PRODUCT_DATA.id,
imageCount: window.NUSENSE_PRODUCT_DATA.images ? window.NUSENSE_PRODUCT_DATA.images.length : 0
});
} else {
console.warn('NUSENSE: NUSENSE_PRODUCT_DATA not found immediately, will check again');
// Check again after a short delay in case it loads late
setTimeout(function() {
if (window.NUSENSE_PRODUCT_DATA) {
console.log('NUSENSE: NUSENSE_PRODUCT_DATA found after delay', {
productId: window.NUSENSE_PRODUCT_DATA.id,
imageCount: window.NUSENSE_PRODUCT_DATA.images ? window.NUSENSE_PRODUCT_DATA.images.length : 0
});
} else {
console.warn('NUSENSE: NUSENSE_PRODUCT_DATA still not found after delay');
}
}, 100);
}
{% else %}
console.warn('NUSENSE: Not on a product page - NUSENSE_PRODUCT_DATA will not be available');
{% endif %}

// Handle case where widget requests images before script is ready
// Process any pending requests that were queued
window.NUSENSE_PENDING_IMAGE_REQUESTS = window.NUSENSE_PENDING_IMAGE_REQUESTS || [];
if (window.NUSENSE_PENDING_IMAGE_REQUESTS.length > 0) {
console.log('NUSENSE: Processing', window.NUSENSE_PENDING_IMAGE_REQUESTS.length, 'pending image requests');
window.NUSENSE_PENDING_IMAGE_REQUESTS.forEach(function(pendingEvent) {
handleImageRequest(pendingEvent);
});
window.NUSENSE_PENDING_IMAGE_REQUESTS = [];
}

console.log('NUSENSE: Script initialization complete', {
listenerActive: window.NUSENSE_MESSAGE_LISTENER_ACTIVE,
hasProductData: !!window.NUSENSE_PRODUCT_DATA,
productId: window.NUSENSE_PRODUCT_DATA ? window.NUSENSE_PRODUCT_DATA.id : null
});
})();</script>



