{% doc %}
  Sets NUSENSE storefront config + (on product pages) exposes product payload and loads the parent bridge.
{% enddoc %}

{% assign widget_url = shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' %}
{% assign debug_mode = shop.metafields.nusense.debug_mode | default: false %}

<script>
(function () {
  if (typeof window === 'undefined') return;

  window.NUSENSE_CONFIG = Object.assign({}, window.NUSENSE_CONFIG || {}, {
    widgetUrl: {{ widget_url | json }},
    debug: {{ debug_mode | default: false | json }},
    autoDetect: true,
    shopDomain: {{ shop.permanent_domain | json }}
  });

  {% if product %}
  {% assign product_images_from_media = product.media | where: 'media_type', 'image' %}
  window.NUSENSE_PRODUCT_DATA = {
    id: {{ product.id }},
    title: {{ product.title | json }},
    price: {{ product.price | money | json }},
    priceRaw: {{ product.price | money_without_currency | json }},
    images: [
      {% if product_images_from_media.size > 0 %}
        {% for media_item in product_images_from_media limit: 20 %}
          {% assign image_url_full = media_item | image_url: width: 1200 %}
          {% unless image_url_full contains '://' %}
            {% assign image_url_full = 'https:' | append: image_url_full %}
          {% endunless %}
          { id: {{ media_item.id }}, url: "{{ image_url_full }}" }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% else %}
        {% for image in product.images limit: 20 %}
          {% assign image_url_full = image | image_url: width: 1200 %}
          {% unless image_url_full contains '://' %}
            {% assign image_url_full = 'https:' | append: image_url_full %}
          {% endunless %}
          { id: {{ image.id }}, url: "{{ image_url_full }}" }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endif %}
    ],
    recommendedProductsUrl: "{{ routes.product_recommendations_url }}?product_id={{ product.id }}&limit=10&intent=related",
    description: {{ product.description | strip_html | truncate: 200 | json }},
    variants: [
      {% for variant in product.variants %}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }},
          price: {{ variant.price | money | json }},
          priceRaw: {{ variant.price | money_without_currency | json }},
          available: {{ variant.available | json }}
          {% if variant.option1 %}, option1: {{ variant.option1 | json }}{% endif %}
          {% if variant.option2 %}, option2: {{ variant.option2 | json }}{% endif %}
          {% if variant.option3 %}, option3: {{ variant.option3 | json }}{% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    url: "{{ shop.url }}{{ product.url }}",
    shop: {
      name: {{ shop.name | json }},
      domain: {{ shop.permanent_domain | json }}
    }
  };

  (function () {
    if (!document || !document.head) return;
    if (document.querySelector('script[src*="nusense-parent-bridge.js"]')) return;
    var script = document.createElement('script');
    script.src = "{{ 'nusense-parent-bridge.js' | asset_url }}";
    script.defer = true;
    document.head.appendChild(script);
  })();
  {% endif %}
})();
</script>


