{% comment %}
  NUSENSE Cart & Outfit Script
  Sets up cart/outfit widget functionality and cart item extraction
{% endcomment %}

{% assign widget_url = shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' %}
{% assign debug_mode = shop.metafields.nusense.debug_mode | default: false %}

<script>
  // Initialize Cart/Outfit widget configuration
  window.NUSENSE_CART_OUTFIT_CONFIG = {
    widgetUrl: '{{ widget_url }}',
    debug: {{ debug_mode }},
    autoDetect: true,
    shopDomain: '{{ shop.permanent_domain }}'
  };
  
  // Cart items data for NUSENSE Cart/Outfit widget
  {% if template.name == 'cart' %}
  // Extract cart items on cart page
  (function() {
    function extractCartItems() {
      const cartItems = [];
      
      // Method 1: Use Cart Ajax API
      fetch('/cart.js')
        .then(function(response) {
          return response.json();
        })
        .then(function(cart) {
          if (cart && cart.items && Array.isArray(cart.items)) {
            cart.items.forEach(function(item) {
              if (item.image) {
                // Ensure absolute URL
                let imageUrl = item.image;
                if (!imageUrl.match(/^https?:\/\//)) {
                  imageUrl = 'https:' + imageUrl;
                }
                
                cartItems.push({
                  id: item.product_id || item.variant_id,
                  url: imageUrl,
                  title: item.product_title || item.title,
                  variantId: item.variant_id,
                  quantity: item.quantity
                });
              }
            });
          }
          
          // Store in global variable for widget access
          window.NUSENSE_CART_ITEMS = cartItems;
          
          // Also send to any open widget iframes
          window.postMessage({
            type: 'NUSENSE_CART_ITEMS',
            items: cartItems
          }, '*');
        })
        .catch(function(error) {
          // Fallback: Extract from DOM
          const cartItemElements = document.querySelectorAll('[data-cart-item], .cart-item, .cart__item');
          const cartItems = [];
          
          cartItemElements.forEach(function(element) {
            const img = element.querySelector('img');
            if (img && img.src) {
              let imageUrl = img.src;
              if (!imageUrl.match(/^https?:\/\//)) {
                imageUrl = 'https:' + imageUrl;
              }
              
              var titleElement = element.querySelector('.cart-item__title, .cart__item-title');
              cartItems.push({
                url: imageUrl,
                title: titleElement ? titleElement.textContent : ''
              });
            }
          });
          
          window.NUSENSE_CART_ITEMS = cartItems;
        });
    }
    
    // Extract cart items when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', extractCartItems);
    } else {
      extractCartItems();
    }
    
    // Re-extract when cart updates
    document.addEventListener('cart:updated', extractCartItems);
    document.addEventListener('cart:add', extractCartItems);
    document.addEventListener('cart:change', extractCartItems);
  })();
  {% endif %}
  
  // Listen for cart/outfit widget requests
  (function() {
    'use strict';
    
    if (window.NUSENSE_CART_OUTFIT_LISTENER_INITIALIZED) {
      return;
    }
    window.NUSENSE_CART_OUTFIT_LISTENER_INITIALIZED = true;
    
    function handleMessage(event) {
      // Handle cart items request
      if (event.data && event.data.type === 'NUSENSE_REQUEST_CART_ITEMS') {
        const cartItems = window.NUSENSE_CART_ITEMS || [];
        
        // If no cart items in memory, try to extract them
        if (cartItems.length === 0 && typeof fetch !== 'undefined') {
          fetch('/cart.js')
            .then(function(response) {
              return response.json();
            })
            .then(function(cart) {
              const items = [];
              if (cart && cart.items && Array.isArray(cart.items)) {
                cart.items.forEach(function(item) {
                  if (item.image) {
                    let imageUrl = item.image;
                    if (!imageUrl.match(/^https?:\/\//)) {
                      imageUrl = 'https:' + imageUrl;
                    }
                    items.push({
                      id: item.product_id || item.variant_id,
                      url: imageUrl,
                      title: item.product_title || item.title,
                      variantId: item.variant_id
                    });
                  }
                });
              }
              
              if (event.source && event.source !== window) {
                event.source.postMessage({
                  type: 'NUSENSE_CART_ITEMS',
                  items: items
                }, '*');
              }
            })
            .catch(function(error) {
              // Send empty array if extraction fails
              if (event.source && event.source !== window) {
                event.source.postMessage({
                  type: 'NUSENSE_CART_ITEMS',
                  items: []
                }, '*');
              }
            });
        } else {
          // Send cached cart items
          if (event.source && event.source !== window) {
            event.source.postMessage({
              type: 'NUSENSE_CART_ITEMS',
              items: cartItems
            }, '*');
          }
        }
      }
      
      // Handle store info request
      if (event.data && event.data.type === 'NUSENSE_REQUEST_STORE_INFO') {
        const storeInfo = {
          type: 'NUSENSE_STORE_INFO',
          domain: window.location.hostname,
          shopDomain: '{{ shop.permanent_domain }}',
          origin: window.location.origin,
          fullUrl: window.location.href
        };
        if (event.source && event.source !== window) {
          event.source.postMessage(storeInfo, '*');
        }
      }
    }
    
    window.addEventListener('message', handleMessage);
  })();
</script>

