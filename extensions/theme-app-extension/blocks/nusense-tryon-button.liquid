{% comment %}
  NUSENSE TryON Button Block
  This block can be added to product pages via the theme editor
  It includes the image extraction listener script automatically
{% endcomment %}

{% comment %} Include the snippet that sets up image extraction and communication {% endcomment %}
{% render 'nusense-tryon-script' %}

{% comment %} Fallback styles for button - ensures primary styling is always visible {% endcomment %}
<style>
  .nusense-tryon-button {
    /* Base button styles - ensures button is always visible and clickable */
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem !important;
    font-size: 1rem !important;
    font-weight: 500 !important;
    text-align: center;
    text-decoration: none;
    cursor: pointer !important;
    border: 1px solid transparent;
    border-radius: 4px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
    min-height: 44px !important;
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
    will-change: transform, box-shadow;
  }
  
  /* Primary button fallback styling - applied by default */
  .nusense-tryon-button.button--primary,
  .nusense-tryon-button.btn-primary,
  .nusense-tryon-button.btn--primary,
  .nusense-tryon-button.button,
  .nusense-tryon-button.btn {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #000000 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06) !important;
    font-weight: 600 !important;
    letter-spacing: 0.01em;
  }
  
  .nusense-tryon-button.button--primary:hover,
  .nusense-tryon-button.btn-primary:hover,
  .nusense-tryon-button.btn--primary:hover,
  .nusense-tryon-button.button:hover,
  .nusense-tryon-button.btn:hover {
    background-color: #1a1a1a !important;
    border-color: #1a1a1a !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    transform: translateY(-1px);
    opacity: 1 !important;
  }
  
  .nusense-tryon-button.button--primary:focus,
  .nusense-tryon-button.btn-primary:focus,
  .nusense-tryon-button.btn--primary:focus,
  .nusense-tryon-button.button:focus,
  .nusense-tryon-button.btn:focus {
    outline: 2px solid #ffffff !important;
    outline-offset: 2px !important;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.15) !important;
  }
  
  .nusense-tryon-button.button--primary:active,
  .nusense-tryon-button.btn-primary:active,
  .nusense-tryon-button.btn--primary:active,
  .nusense-tryon-button.button:active,
  .nusense-tryon-button.btn:active {
    background-color: #0d0d0d !important;
    border-color: #0d0d0d !important;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    transform: translateY(0);
  }
  
  /* If no theme classes detected at all, ensure perfect primary action button styling */
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]) {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-color: #000000 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06) !important;
    font-weight: 600 !important;
    letter-spacing: 0.01em;
    text-transform: none;
    position: relative;
    overflow: hidden;
  }
  
  /* Hover state - professional action button hover */
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):hover {
    background-color: #1a1a1a !important;
    border-color: #1a1a1a !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    transform: translateY(-1px);
    opacity: 1 !important;
  }
  
  /* Focus state - accessibility and keyboard navigation */
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):focus {
    outline: 2px solid #ffffff !important;
    outline-offset: 2px !important;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.15) !important;
  }
  
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):focus:not(:focus-visible) {
    outline: none !important;
  }
  
  /* Active/pressed state - provides tactile feedback */
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):active {
    background-color: #0d0d0d !important;
    border-color: #0d0d0d !important;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    transform: translateY(0);
  }
  
  /* Disabled state - when button is loading or disabled */
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"])[disabled],
  .nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"])[aria-disabled="true"] {
    background-color: #666666 !important;
    border-color: #666666 !important;
    color: #ffffff !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
    box-shadow: none !important;
    transform: none !important;
  }
  
  /* Full width */
  .nusense-tryon-button.button--full-width,
  .nusense-tryon-button.btn-block,
  .nusense-tryon-button.btn--full-width {
    width: 100% !important;
  }
  
  /* Ensure button text is visible */
  .nusense-tryon-button .button__text {
    color: inherit !important;
  }
  
  /* Ensure button is always visible */
  .nusense-tryon-button[style*="display: none"] {
    display: inline-flex !important;
  }
  
  /* Loading state */
  .nusense-tryon-button[data-loading="true"] {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Widget overlay styles */
  .nusense-widget-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .nusense-widget-container {
    position: relative;
    width: 95vw;
    max-width: 1200px;
    height: 90vh;
  }
  
  .nusense-widget-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .nusense-widget-close:hover {
    background: #f0f0f0;
  }
  
  .nusense-widget-close:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
  }
</style>

{% schema %}
{
  "name": "NUSENSE Try-On Button",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Try Now"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "minimal",
          "label": "Minimal"
        }
      ],
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show Icon",
      "default": true
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "✨"
    },
    {
      "type": "checkbox",
      "id": "button_width_full",
      "label": "Full Width Button",
      "default": true,
      "info": "Enable to make button full width. Disable to allow flexible width (can be placed next to other buttons)"
    },
    {
      "type": "checkbox",
      "id": "auto_position_above_cart",
      "label": "Auto-position Above Add to Cart",
      "default": true,
      "info": "Automatically position the button above the Add to Cart button on product pages"
    },
    {
      "type": "header",
      "content": "Positioning & Spacing"
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Button Alignment",
      "options": [
        {
          "value": "auto",
          "label": "Auto (Match Theme)"
        },
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "auto",
      "info": "Horizontal alignment of the button. 'Auto' matches the Add to Cart button alignment."
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space above the button"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0.8,
      "unit": "rem",
      "info": "Space below the button (spacing before Add to Cart button)"
    },
    {
      "type": "range",
      "id": "margin_left",
      "label": "Left Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the left of the button"
    },
    {
      "type": "range",
      "id": "margin_right",
      "label": "Right Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the right of the button"
    },
    {
      "type": "header",
      "content": "Advanced Customization"
    },
    {
      "type": "color",
      "id": "button_background_color",
      "label": "Button Background Color",
      "info": "Override theme colors with a custom background color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "info": "Override theme colors with a custom text color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Button Border Color",
      "info": "Override theme colors with a custom border color. Leave empty to use theme colors."
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Font Size (px)",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px",
      "info": "Customize button font size"
    },
    {
      "type": "range",
      "id": "button_padding",
      "label": "Padding (rem)",
      "min": 0.2,
      "max": 3,
      "step": 0.2,
      "default": 0.8,
      "unit": "rem",
      "info": "Customize button padding"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 4,
      "unit": "px",
      "info": "Customize button border radius"
    },
    {
      "type": "text",
      "id": "custom_css",
      "label": "Custom CSS",
      "info": "Add custom CSS to further customize the button. Use selector: .nusense-tryon-button",
      "placeholder": ".nusense-tryon-button { /* your styles */ }"
    }
  ]
}
{% endschema %}

{% comment %}
  Read all block settings with proper defaults
  Checkboxes return true/false or nil, so we need to handle them properly
{% endcomment %}
{% assign button_text = block.settings.button_text | default: 'Try Now' %}
{% assign button_style = block.settings.button_style | default: 'primary' %}
{% assign button_icon = block.settings.button_icon | default: '✨' %}
{% assign button_background_color = block.settings.button_background_color %}
{% assign button_text_color = block.settings.button_text_color %}
{% assign button_border_color = block.settings.button_border_color %}
{% assign button_font_size = block.settings.button_font_size | default: 16 %}
{% assign button_padding = block.settings.button_padding | default: 0.8 %}
{% assign button_border_radius = block.settings.button_border_radius | default: 4 %}
{% assign button_alignment = block.settings.button_alignment | default: 'auto' %}
{% assign margin_top = block.settings.margin_top | default: 0 %}
{% assign margin_bottom = block.settings.margin_bottom | default: 0.8 %}
{% assign margin_left = block.settings.margin_left | default: 0 %}
{% assign margin_right = block.settings.margin_right | default: 0 %}

{% comment %}
  Handle checkbox values - they can be true, false, or nil
{% endcomment %}
{% if block.settings.show_icon == true or block.settings.show_icon == 'true' %}
  {% assign show_icon = true %}
{% else %}
  {% assign show_icon = false %}
{% endif %}

{% if block.settings.button_width_full == true or block.settings.button_width_full == 'true' %}
  {% assign button_width_full = true %}
{% else %}
  {% assign button_width_full = false %}
{% endif %}

{% if block.settings.auto_position_above_cart == true or block.settings.auto_position_above_cart == 'true' %}
  {% assign auto_position_above_cart = true %}
{% else %}
  {% assign auto_position_above_cart = false %}
{% endif %}

{% comment %}
  Build button classes based on style variant
  Shopify themes use various naming conventions:
  - Dawn/Debut: button, button--primary, button--secondary, button--outline
  - Custom themes: btn, btn-primary, btn-secondary, etc.
  We'll use JavaScript to detect and match the theme's button classes
{% endcomment %}
{% assign button_classes = 'button nusense-tryon-button' %}
{% case button_style %}
  {% when 'secondary' %}
    {% assign button_classes = button_classes | append: ' button--secondary' %}
  {% when 'outline' %}
    {% assign button_classes = button_classes | append: ' button--outline' %}
  {% when 'minimal' %}
    {% assign button_classes = button_classes | append: ' button--tertiary' %}
  {% else %}
    {% assign button_classes = button_classes | append: ' button--primary' %}
{% endcase %}
{% if button_width_full %}
  {% assign button_classes = button_classes | append: ' button--full-width' %}
{% endif %}

<button 
  id="nusense-tryon-btn-{{ block.id }}" 
  class="{{ button_classes }}"
  {{ block.shopify_attributes }}
  aria-label="{{ button_text }}"
  data-product-id="{{ product.id }}"
  data-shop-domain="{{ shop.permanent_domain }}"
  data-button-style="{{ button_style }}"
  data-show-icon="{{ show_icon }}"
  data-button-width-full="{{ button_width_full }}"
  data-auto-position="{{ auto_position_above_cart }}"
  data-background-color="{{ button_background_color }}"
  data-text-color="{{ button_text_color }}"
  data-border-color="{{ button_border_color }}"
  data-font-size="{{ button_font_size }}"
  data-padding="{{ button_padding }}"
  data-border-radius="{{ button_border_radius }}"
  data-alignment="{{ button_alignment }}"
  data-margin-top="{{ margin_top }}"
  data-margin-bottom="{{ margin_bottom }}"
  data-margin-left="{{ margin_left }}"
  data-margin-right="{{ margin_right }}"
  data-button-icon="{{ button_icon }}"
  data-widget-url="{{ shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' }}"
  data-loading="true"
  style="display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;{% if button_width_full %} width: 100%;{% endif %}"
>
  <span class="button__icon" data-icon="{{ button_icon }}" aria-hidden="true" style="{% unless show_icon %}display: none;{% endunless %}">{{ button_icon }}</span>
  <span class="button__text" id="nusense-tryon-desc-{{ block.id }}">{{ button_text }}</span>
</button>

{% comment %} Load external JavaScript file {% endcomment %}
<script src="{{ 'nusense-tryon-button.js' | asset_url }}" defer></script>
