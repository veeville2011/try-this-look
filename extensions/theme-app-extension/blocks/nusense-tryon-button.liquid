{% comment %}
  NUSENSE TryON Button Block
  This block can be added to product pages via the theme editor
  It includes the image extraction listener script automatically
{% endcomment %}

{% comment %} Include the snippet that sets up image extraction and communication {% endcomment %}
{% render 'nusense-tryon-script' %}

{% schema %}
{
  "name": "NUSENSE Try-On Button",
  "target": "section",
  "available_if": "{{ app.metafields.subscription.active.value }}",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Try Now"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "minimal",
          "label": "Minimal"
        }
      ],
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show Icon",
      "default": true
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "✨"
    },
    {
      "type": "checkbox",
      "id": "button_width_full",
      "label": "Full Width Button",
      "default": true,
      "info": "Enable to make button full width. Disable to allow flexible width (can be placed next to other buttons)"
    }
  ]
}
{% endschema %}

{% comment %}
  Read all block settings with proper defaults
  Checkboxes return true/false or nil, so we need to handle them properly
{% endcomment %}
{% assign button_text = block.settings.button_text | default: 'Try Now' %}
{% assign button_style = block.settings.button_style | default: 'primary' %}
{% assign button_icon = block.settings.button_icon | default: '✨' %}

{% comment %}
  Handle checkbox values - they can be true, false, or nil
{% endcomment %}
{% if block.settings.show_icon == true or block.settings.show_icon == 'true' %}
  {% assign show_icon = true %}
{% else %}
  {% assign show_icon = false %}
{% endif %}

{% if block.settings.button_width_full == true or block.settings.button_width_full == 'true' %}
  {% assign button_width_full = true %}
{% else %}
  {% assign button_width_full = false %}
{% endif %}

{% comment %}
  Build button classes based on style variant
  Shopify themes typically use: button, button--secondary, button--outline, button--tertiary
{% endcomment %}
{% assign button_classes = 'button' %}
{% case button_style %}
  {% when 'secondary' %}
    {% assign button_classes = button_classes | append: ' button--secondary' %}
  {% when 'outline' %}
    {% assign button_classes = button_classes | append: ' button--outline' %}
  {% when 'minimal' %}
    {% assign button_classes = button_classes | append: ' button--tertiary' %}
  {% else %}
    {% comment %} Primary - no additional class needed {% endcomment %}
{% endcase %}
{% if button_width_full %}
  {% assign button_classes = button_classes | append: ' button--full-width' %}
{% endif %}

<button 
  id="nusense-tryon-btn-{{ block.id }}" 
  class="{{ button_classes }}"
  {{ block.shopify_attributes }}
  aria-label="{{ button_text }}"
  data-product-id="{{ product.id }}"
  data-shop-domain="{{ shop.permanent_domain }}"
  data-button-style="{{ button_style }}"
  data-show-icon="{{ show_icon }}"
  data-button-width-full="{{ button_width_full }}"
  type="button"
  style="display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;{% if button_width_full %} width: 100%;{% endif %}"
>
  <span class="button__icon" data-icon="{{ button_icon }}" style="{% unless show_icon %}display: none;{% endunless %}">{{ button_icon }}</span>
  <span class="button__text">{{ button_text }}</span>
</button>

<script>
  (function() {
    const button = document.getElementById('nusense-tryon-btn-{{ block.id }}');
    if (!button) return;
    
    // Function to apply all button configurations
    const applyButtonConfig = function() {
      // Get all settings from data attributes
      const buttonStyle = button.dataset.buttonStyle || '{{ button_style }}' || 'primary';
      const showIcon = button.dataset.showIcon === 'true' || button.dataset.showIcon === true;
      const buttonWidthFull = button.dataset.buttonWidthFull === 'true' || button.dataset.buttonWidthFull === true;
      
      // Apply button style classes
      let classes = button.className
        .replace(/\s*button--secondary\s*/g, ' ')
        .replace(/\s*button--outline\s*/g, ' ')
        .replace(/\s*button--tertiary\s*/g, ' ')
        .replace(/\s*button--full-width\s*/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      
      // Ensure base button class is present
      if (!classes.includes('button')) {
        classes = 'button ' + classes;
      }
      
      // Apply style variant
      if (buttonStyle === 'secondary') {
        classes += ' button--secondary';
      } else if (buttonStyle === 'outline') {
        classes += ' button--outline';
      } else if (buttonStyle === 'minimal') {
        classes += ' button--tertiary';
      }
      
      // Apply full width class
      if (buttonWidthFull) {
        classes += ' button--full-width';
      }
      
      button.className = classes.trim();
      
      // Apply width style
      if (buttonWidthFull) {
        button.style.width = '100%';
      } else {
        button.style.width = '';
      }
      
      // Handle icon visibility and text
      const iconSpan = button.querySelector('.button__icon');
      if (iconSpan) {
        iconSpan.style.display = showIcon ? 'inline' : 'none';
        // Update icon text if data attribute exists
        const iconText = iconSpan.dataset.icon || '{{ button_icon }}';
        if (iconText && iconSpan.textContent !== iconText) {
          iconSpan.textContent = iconText;
        }
      }
      
      // Config applied
    };
    
    // Apply configuration on load
    applyButtonConfig();
    
    // Watch for changes in the theme editor
    const observer = new MutationObserver(function(mutations) {
      let shouldUpdate = false;
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes') {
          const attrName = mutation.attributeName;
          if (attrName === 'data-button-style' || 
              attrName === 'data-show-icon' || 
              attrName === 'data-button-width-full' ||
              attrName === 'class') {
            shouldUpdate = true;
          }
        }
      });
      if (shouldUpdate) {
        applyButtonConfig();
      }
    });
    
    observer.observe(button, {
      attributes: true,
      attributeFilter: ['data-button-style', 'data-show-icon', 'data-button-width-full', 'class'],
      subtree: true
    });
    
    // Also check periodically for theme editor updates
    let lastConfig = JSON.stringify({
      style: button.dataset.buttonStyle,
      showIcon: button.dataset.showIcon,
      fullWidth: button.dataset.buttonWidthFull
    });
    
    const configChecker = setInterval(function() {
      const currentConfig = JSON.stringify({
        style: button.dataset.buttonStyle,
        showIcon: button.dataset.showIcon,
        fullWidth: button.dataset.buttonWidthFull
      });
      
      if (currentConfig !== lastConfig) {
        lastConfig = currentConfig;
        applyButtonConfig();
      }
    }, 500);
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      observer.disconnect();
      clearInterval(configChecker);
    });
    
    const productId = button.dataset.productId;
    const shopDomain = button.dataset.shopDomain || '{{ shop.permanent_domain }}';
    
    button.addEventListener('click', function() {
      // Open widget in modal or iframe
      // App proxy URL format: /apps/apps/a/{path}
      // Or use direct app URL if app proxy not needed
      const widgetUrl = '{{ shop.metafields.nusense.widget_url | default: "https://try-this-look.vercel.app" }}/widget?product_id=' + productId + '&shop_domain=' + encodeURIComponent(shopDomain);
      
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.id = 'nusense-widget-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.2);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // Create container for iframe
      const container = document.createElement('div');
      container.style.cssText = `
        position: relative;
        width: 95vw;
        max-width: 1200px;
        height: 90vh;
      `;
      
      // Close function
      const closeWidget = function() {
        if (overlay && overlay.parentNode) {
          document.body.removeChild(overlay);
          document.body.style.overflow = '';
        }
      };
      
      // Create iframe
      const iframe = document.createElement('iframe');
      iframe.src = widgetUrl;
      iframe.style.cssText = `
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0.25rem;
        background: white;
      `;
      iframe.allow = 'camera; microphone';
      iframe.setAttribute('allowfullscreen', 'true');
      
      // Assemble modal
      container.appendChild(iframe);
      overlay.appendChild(container);
      document.body.appendChild(overlay);
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      
      // Close on escape key
      const closeHandler = function(e) {
        if (e.key === 'Escape') {
          closeWidget();
          document.removeEventListener('keydown', closeHandler);
        }
      };
      document.addEventListener('keydown', closeHandler);
      
      // Listen for messages from iframe
      window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'NUSENSE_CLOSE_WIDGET') {
          closeWidget();
        }
        
        // Handle store info request from iframe
        if (e.data && e.data.type === 'NUSENSE_REQUEST_STORE_INFO') {
          const storeInfo = {
            type: 'NUSENSE_STORE_INFO',
            domain: window.location.hostname,
            shopDomain: shopDomain || '{{ shop.permanent_domain }}',
            origin: window.location.origin,
            fullUrl: window.location.href
          };
          iframe.contentWindow.postMessage(storeInfo, '*');
        }
      });
    });
  })();
</script>

