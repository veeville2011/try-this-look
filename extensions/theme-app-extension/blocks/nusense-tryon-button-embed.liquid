
{% comment %} Output customer information as JSON script tag for widget loader to read {% endcomment %}
{% if customer %}
  <script type="application/json" id="nusense-customer-info">
    {
      "id": {{ customer.id | json }},
      "email": {{ customer.email | json }},
      "firstName": {% if customer.first_name %}{{ customer.first_name | json }}{% else %}null{% endif %},
      "lastName": {% if customer.last_name %}{{ customer.last_name | json }}{% else %}null{% endif %}
    }
  </script>
{% endif %}

{% render 'nusense-tryon-script' %}

<style>
  .nusense-tryon-button-embed-container {
    /* Layout-transparent wrapper: the button appears "without a wrapper" */
    display: none;
  }

  .nusense-tryon-button-embed-container.is-positioned {
    display: contents;
  }

  .nusense-tryon-button[data-loading="true"] {
    opacity: 0.7;
    pointer-events: none;
  }
  
  .nusense-tryon-button .button__text {
    color: inherit;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    line-height: inherit;
    letter-spacing: inherit;
    text-transform: inherit;
  }
</style>

{% schema %}
{
  "name": "NUSENSE Try-On Button",
  "target": "body",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "TryOn"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "minimal",
          "label": "Minimal"
        }
      ],
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show Icon",
      "default": true
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "✨"
    },
    {
      "type": "checkbox",
      "id": "button_width_full",
      "label": "Full Width Button",
      "default": true,
      "info": "Enable to make button full width. Disable to allow flexible width (can be placed next to other buttons)"
    },
    {
      "type": "range",
      "id": "button_width_percent",
      "label": "Button width (%) when Full Width is off",
      "min": 10,
      "max": 100,
      "step": 1,
      "default": 100,
      "unit": "%",
      "info": "Applies only when Full Width Button is disabled."
    },
    {
      "type": "header",
      "content": "Positioning & Spacing"
    },
    {
      "type": "paragraph",
      "content": "The button will automatically appear on all product pages. Use the spacing settings below to adjust margins around the button."
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Button Alignment",
      "options": [
        {
          "value": "auto",
          "label": "Auto (Match Theme)"
        },
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "auto",
      "info": "Horizontal alignment of the button. 'Auto' matches the Add to Cart button alignment."
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space above the button"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space below the button (spacing before Add to Cart button)"
    },
    {
      "type": "range",
      "id": "margin_left",
      "label": "Left Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the left of the button"
    },
    {
      "type": "range",
      "id": "margin_right",
      "label": "Right Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the right of the button"
    },
    {
      "type": "header",
      "content": "Advanced Customization"
    },
    {
      "type": "color",
      "id": "button_background_color",
      "label": "Button Background Color",
      "info": "Override theme colors with a custom background color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "info": "Override theme colors with a custom text color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Button Border Color",
      "info": "Override theme colors with a custom border color. Leave empty to use theme colors."
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Font Size (px)",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px",
      "info": "Customize button font size"
    },
    {
      "type": "range",
      "id": "button_padding",
      "label": "Padding (rem)",
      "min": 0.2,
      "max": 3,
      "step": 0.2,
      "default": 0.8,
      "unit": "rem",
      "info": "Customize button padding"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 4,
      "unit": "px",
      "info": "Customize button border radius"
    },
    {
      "type": "text",
      "id": "custom_css",
      "label": "Custom CSS",
      "info": "Add custom CSS to further customize the button. Use selector: .nusense-tryon-button",
      "placeholder": ".nusense-tryon-button { /* your styles */ }"
    }
  ]
}
{% endschema %}

{% assign button_text = block.settings.button_text | default: 'TryOn' %}
{% assign button_style = block.settings.button_style | default: 'primary' %}
{% assign button_icon = block.settings.button_icon | default: '✨' %}
{% assign button_background_color = block.settings.button_background_color %}
{% assign button_text_color = block.settings.button_text_color %}
{% assign button_border_color = block.settings.button_border_color %}
{% assign button_font_size = block.settings.button_font_size | default: 16 %}
{% assign button_padding = block.settings.button_padding | default: 0.8 %}
{% assign button_border_radius = block.settings.button_border_radius | default: 4 %}
{% assign button_alignment = block.settings.button_alignment | default: 'auto' %}
{% assign button_width_percent = block.settings.button_width_percent | default: 100 %}
{% assign margin_top = block.settings.margin_top | default: 0 %}
{% assign margin_bottom = block.settings.margin_bottom | default: 0 %}
{% assign margin_left = block.settings.margin_left | default: 0 %}
{% assign margin_right = block.settings.margin_right | default: 0 %}
{% assign custom_css = block.settings.custom_css %}

{% if block.settings.show_icon == true or block.settings.show_icon == 'true' %}
  {% assign show_icon = true %}
{% else %}
  {% assign show_icon = false %}
{% endif %}

{% if block.settings.button_width_full == true or block.settings.button_width_full == 'true' %}
  {% assign button_width_full = true %}
{% else %}
  {% assign button_width_full = false %}
{% endif %}

{% assign button_classes = 'button nusense-tryon-button' %}
{% case button_style %}
  {% when 'secondary' %}
    {% assign button_classes = button_classes | append: ' button--secondary' %}
  {% when 'outline' %}
    {% assign button_classes = button_classes | append: ' button--outline' %}
  {% when 'minimal' %}
    {% assign button_classes = button_classes | append: ' button--tertiary' %}
  {% else %}
    {% assign button_classes = button_classes | append: ' button--primary' %}
{% endcase %}
{% if button_width_full %}
  {% assign button_classes = button_classes | append: ' button--full-width' %}
{% endif %}

<div 
  id="nusense-tryon-button-embed-{{ block.id }}" 
  class="nusense-tryon-button-embed-container"
  data-block-id="{{ block.id }}"
  {{ block.shopify_attributes }}
  data-button-text="{{ button_text | escape }}"
  data-button-style="{{ button_style | escape }}"
  data-button-icon="{{ button_icon | escape }}"
  data-show-icon="{{ show_icon }}"
  data-button-width-full="{{ button_width_full }}"
  data-width-percent="{{ button_width_percent }}"
  data-button-classes="{{ button_classes | escape }}"
  data-button-alignment="{{ button_alignment | escape }}"
  data-margin-top="{{ margin_top }}"
  data-margin-bottom="{{ margin_bottom }}"
  data-margin-left="{{ margin_left }}"
  data-margin-right="{{ margin_right }}"
  {% if button_background_color != blank %}data-background-color="{{ button_background_color | escape }}"{% endif %}
  {% if button_text_color != blank %}data-text-color="{{ button_text_color | escape }}"{% endif %}
  {% if button_border_color != blank %}data-border-color="{{ button_border_color | escape }}"{% endif %}
  {% if button_font_size != blank %}data-font-size="{{ button_font_size | escape }}"{% endif %}
  {% if button_padding != blank %}data-padding="{{ button_padding | escape }}"{% endif %}
  {% if button_border_radius != blank %}data-border-radius="{{ button_border_radius | escape }}"{% endif %}
  {% if custom_css != blank %}data-custom-css="{{ custom_css | strip_newlines | escape }}"{% endif %}
  data-widget-url="{{ shop.metafields.nusense.widget_url | default: 'https://try-this-look-jet.vercel.app' | escape }}"
  data-shop-domain="{{ shop.permanent_domain | escape }}"
>
  <button 
    id="nusense-tryon-btn-{{ block.id }}" 
    class="{{ button_classes }}"
    type="button"
    aria-label="{{ button_text | escape }}"
    {% if product %}data-product-id="{{ product.id }}"{% else %}data-product-id=""{% endif %}
    data-shop-domain="{{ shop.permanent_domain | escape }}"
    data-button-style="{{ button_style | escape }}"
    data-show-icon="{{ show_icon }}"
    data-button-width-full="{{ button_width_full }}"
    data-width-percent="{{ button_width_percent }}"
    {% if button_background_color != blank %}data-background-color="{{ button_background_color | escape }}"{% endif %}
    {% if button_text_color != blank %}data-text-color="{{ button_text_color | escape }}"{% endif %}
    {% if button_border_color != blank %}data-border-color="{{ button_border_color | escape }}"{% endif %}
    {% if button_font_size != blank %}data-font-size="{{ button_font_size | escape }}"{% endif %}
    {% if button_padding != blank %}data-padding="{{ button_padding | escape }}"{% endif %}
    {% if button_border_radius != blank %}data-border-radius="{{ button_border_radius | escape }}"{% endif %}
    data-alignment="{{ button_alignment | escape }}"
    data-margin-top="{{ margin_top }}"
    data-margin-bottom="{{ margin_bottom }}"
    data-margin-left="{{ margin_left }}"
    data-margin-right="{{ margin_right }}"
    data-button-icon="{{ button_icon | escape }}"
    {% if custom_css != blank %}data-custom-css="{{ custom_css | strip_newlines | escape }}"{% endif %}
    data-widget-url="{{ shop.metafields.nusense.widget_url | default: 'https://try-this-look-jet.vercel.app' | escape }}"
    data-loading="true"
    style="display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;{% if button_width_full %} width: 100%;{% else %}{% if button_width_percent != blank and button_width_percent != 100 %} width: {{ button_width_percent }}%;{% endif %}{% endif %}"
  >
    <span class="button__icon" data-icon="{{ button_icon | escape }}" aria-hidden="true" style="{% unless show_icon %}display: none;{% endunless %}">{{ button_icon | escape }}</span>
    <span class="button__text" id="nusense-tryon-desc-{{ block.id }}">{{ button_text | escape }}</span>
  </button>
</div>

<script>
  (function () {
    if (typeof window === 'undefined') return;
    if (!document || !document.head) return;
    if (document.querySelector('script[src*="nusense-tryon-button.js"]')) return;

    var script = document.createElement('script');
    script.src = "{{ 'nusense-tryon-button.js' | asset_url }}";
    script.defer = true;
    document.head.appendChild(script);
  })();
</script>

<script>(function() {
'use strict';
const blockId = '{{ block.id }}';
const containerId = 'nusense-tryon-button-embed-' + blockId;
const buttonId = 'nusense-tryon-btn-' + blockId;
let isPositioning = false;
let lastPositionedUrl = null;
function isElementVisible(element) {
if (!element) return false;
const style = window.getComputedStyle(element);
if (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity) < 0.1) {
return false;
}
if (element.disabled === true || element.hasAttribute('disabled')) {
return false;
}
if (element.offsetWidth === 0 && element.offsetHeight === 0 && style.position !== 'absolute' && style.position !== 'fixed') {
return false;
}
let parent = element.parentElement;
while (parent && parent !== document.body) {
const parentStyle = window.getComputedStyle(parent);
const parentId = String(parent.getAttribute('id') || parent.id || '');
const parentClass = String(parent.className || (parent.classList ? Array.from(parent.classList).join(' ') : ''));
if (parentStyle.display === 'none' ||
parentStyle.visibility === 'hidden' ||
(typeof parentId === 'string' && (parentId.includes('drawer') || parentId.includes('modal') || parentId.includes('popup') || parentId.includes('quick-view'))) ||
(typeof parentClass === 'string' && (parentClass.includes('drawer') || parentClass.includes('modal') || parentClass.includes('popup') || parentClass.includes('quick-view')))) {
return false;
}
parent = parent.parentElement;
}
return true;
}
function findVisibleButtons(container) {
if (!container) return [];
const allButtons = Array.from(container.querySelectorAll('button, input[type="submit"], input[type="button"]'));
return allButtons.filter(btn => isElementVisible(btn) && !btn.disabled && btn.getAttribute('aria-hidden') !== 'true');
}
function isHorizontalLayout(element) {
if (!element) return false;
const style = window.getComputedStyle(element);
const display = style.display;
const flexDirection = style.flexDirection;
const gridTemplateColumns = style.gridTemplateColumns;
return (display === 'flex' || display === 'inline-flex') && (flexDirection === 'row' || flexDirection === 'row-reverse' || flexDirection === '') ||
(display === 'grid' && gridTemplateColumns !== 'none');
}
function parseCssPx(value) {
if (value == null) return null;
const raw = String(value).trim();
if (!raw) return null;
const px = parseFloat(raw);
if (Number.isNaN(px)) return null;
return px;
}
function getThemeGapPxFromContainer(container) {
if (!container) return null;
const style = window.getComputedStyle(container);
// Prefer explicit gaps for flex/grid containers.
const gap = parseCssPx(style.gap);
if (gap != null && gap > 0) return gap;
const rowGap = parseCssPx(style.rowGap);
if (rowGap != null && rowGap > 0) return rowGap;
// Some themes space children by margins; use margin-block-start of the group if present.
return null;
}
function inferVerticalGapPxFromButtons(groupEl) {
if (!groupEl || !groupEl.querySelector) return null;
const buttons = findVisibleButtons(groupEl);
if (buttons.length < 2) return null;
// Find the first pair that are vertically stacked (same column-ish).
for (let i = 0; i < buttons.length - 1; i += 1) {
const a = buttons[i];
const b = buttons[i + 1];
const ra = a.getBoundingClientRect();
const rb = b.getBoundingClientRect();
if (!ra || !rb) continue;
const sameColumn = Math.abs(ra.left - rb.left) <= 8;
const stacked = rb.top > ra.top;
if (!sameColumn || !stacked) continue;
const gap = rb.top - ra.bottom;
if (gap >= 0 && gap <= 80) return gap;
}
return null;
}
function applyThemeSpacingIfUnset(buttonEl, groupEl, parentEl) {
if (!buttonEl) return;
// Respect merchant settings / explicit inline margins.
const marginTopSetting = String(buttonEl.dataset.marginTop || '0');
const marginBottomSetting = String(buttonEl.dataset.marginBottom || '0');
if (marginTopSetting !== '0' || marginBottomSetting !== '0') return;
if (buttonEl.style.marginTop || buttonEl.style.marginBottom) return;

// If parent uses column gap, the spacing will be handled automatically.
if (parentEl) {
const parentStyle = window.getComputedStyle(parentEl);
const isColumnFlex = (parentStyle.display === 'flex' || parentStyle.display === 'inline-flex') && parentStyle.flexDirection === 'column';
const parentGap = getThemeGapPxFromContainer(parentEl);
if (isColumnFlex && parentGap != null && parentGap > 0) return;
if (parentStyle.display === 'grid') {
const gridGap = getThemeGapPxFromContainer(parentEl);
if (gridGap != null && gridGap > 0) return;
}
}

// Prefer the group container's gap/row-gap, else measure button spacing inside the group.
const groupGap = getThemeGapPxFromContainer(groupEl);
const inferredGap = groupGap != null ? groupGap : inferVerticalGapPxFromButtons(groupEl);
const finalGap = inferredGap != null && inferredGap > 0 ? inferredGap : 12;
buttonEl.style.marginBottom = `${finalGap}px`;
}
function findPurchaseActionBoundary() {
const allForms = Array.from(document.querySelectorAll('form[action*="/cart/add"]'));
let productForm = allForms.find(form => {
const formClass = String(form.className || '').toLowerCase();
const formId = String(form.id || '').toLowerCase();
return !formClass.includes('payment-terms') && !formId.includes('payment-terms') && !formId.includes('installment');
}) || allForms[0];
if (!productForm) return null;
let submitButtons = Array.from(productForm.querySelectorAll('button[type="submit"], input[type="submit"], button:not([type])'));
if (submitButtons.length === 0 && productForm.id) {
submitButtons = Array.from(document.querySelectorAll('button[form="' + productForm.id + '"], input[form="' + productForm.id + '"]'));
}
if (submitButtons.length === 0) {
const formParent = productForm.parentElement;
if (formParent && formParent !== document.body && formParent !== document.documentElement) {
return {isGroup: false, insertTarget: productForm, insertParent: formParent};
}
return null;
}
const visibleSubmitButtons = submitButtons.filter(btn => isElementVisible(btn) && !btn.disabled && btn.getAttribute('aria-hidden') !== 'true');
if (visibleSubmitButtons.length === 0) {
const formParent = productForm.parentElement;
if (formParent && formParent !== document.body && formParent !== document.documentElement) {
return {isGroup: false, insertTarget: productForm, insertParent: formParent};
}
return null;
}
const primarySubmitButton = visibleSubmitButtons[0];
const buttonParent = primarySubmitButton.parentElement;
const wrapperParent = buttonParent ? buttonParent.parentElement : null;
if (buttonParent && wrapperParent && wrapperParent !== document.body && wrapperParent !== document.documentElement) {
  const looksLikePurchaseGroup = function(el) {
    if (!el) return false;
    const elId = String(el.getAttribute && el.getAttribute('id') ? el.getAttribute('id') : '').toLowerCase();
    const elClass = String(el.className || '').toLowerCase();
    const hasPaymentButton = !!(el.querySelector && el.querySelector('.shopify-payment-button, .shopify-payment-button__button, [data-shopify="payment-button"], [data-testid*="shopify-payment"]'));
    const visibleButtons = findVisibleButtons(el);
    const hasMultipleButtons = visibleButtons.length > 1;
    const keywordMatch =
      elClass.includes('buy') ||
      elClass.includes('payment') ||
      elClass.includes('checkout') ||
      elClass.includes('product-form') ||
      elClass.includes('button') ||
      elClass.includes('buttons') ||
      elId.includes('buy') ||
      elId.includes('payment') ||
      elId.includes('checkout') ||
      elId.includes('product-form') ||
      elId.includes('button') ||
      elId.includes('buttons');
    return Boolean(hasPaymentButton || hasMultipleButtons || keywordMatch || isHorizontalLayout(el));
  };

  // Climb up to find the OUTER buy-buttons container (themes often nest button wrappers).
  let cursor = wrapperParent;
  let bestGroup = null;
  let depth = 0;
  while (cursor && cursor !== document.body && cursor !== document.documentElement && cursor !== productForm && depth < 5) {
    if (looksLikePurchaseGroup(cursor) && cursor.parentElement && cursor.parentElement !== document.body && cursor.parentElement !== document.documentElement) {
      bestGroup = cursor;
    }
    cursor = cursor.parentElement;
    depth += 1;
  }

  if (bestGroup && bestGroup.parentElement) {
    return {isGroup: true, insertTarget: bestGroup, insertParent: bestGroup.parentElement};
  }

  // Fallback: insert relative to the primary button wrapper (closest stable target).
  return {isGroup: false, insertTarget: buttonParent, insertParent: wrapperParent};
}
return {isGroup: false, insertTarget: primarySubmitButton, insertParent: buttonParent};
}
function getProductId() {
if (window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.id) {
return window.NUSENSE_PRODUCT_DATA.id;
}
if (window.Shopify && window.Shopify.product && window.Shopify.product.id) {
return window.Shopify.product.id;
}
try {
const jsonScripts = document.querySelectorAll('script[type="application/json"]');
for (let script of jsonScripts) {
try {
const data = JSON.parse(script.textContent);
if (data.product && data.product.id) {
return data.product.id;
}
} catch (e) {
}
}
} catch (e) {
}
return null;
}
function isThemeEditor() {
return !!(window.Shopify && window.Shopify.designMode);
}
function inheritTypographyFromButton(button, targetButton) {
if (!button || !targetButton || button === targetButton || !isElementVisible(targetButton)) {
return;
}
if (button.dataset.fontSize) {
return;
}
const targetStyle = window.getComputedStyle(targetButton);
const fontFamily = targetStyle.getPropertyValue('font-family');
const fontSize = targetStyle.getPropertyValue('font-size');
const fontWeight = targetStyle.getPropertyValue('font-weight');
const lineHeight = targetStyle.getPropertyValue('line-height');
const letterSpacing = targetStyle.getPropertyValue('letter-spacing');
const textTransform = targetStyle.getPropertyValue('text-transform');
if (fontFamily && fontFamily !== 'initial' && fontFamily !== 'inherit' && fontFamily.trim() !== '') {
button.style.setProperty('font-family', fontFamily, 'important');
}
if (fontSize && fontSize !== 'initial' && fontSize !== 'inherit' && fontSize.trim() !== '' && !button.dataset.fontSize) {
button.style.setProperty('font-size', fontSize, 'important');
}
if (fontWeight && fontWeight !== 'initial' && fontWeight !== 'inherit' && fontWeight.trim() !== '') {
button.style.setProperty('font-weight', fontWeight, 'important');
}
if (lineHeight && lineHeight !== 'initial' && lineHeight !== 'inherit' && lineHeight.trim() !== '') {
button.style.setProperty('line-height', lineHeight, 'important');
}
if (letterSpacing && letterSpacing !== 'initial' && letterSpacing !== 'inherit' && letterSpacing.trim() !== '') {
button.style.setProperty('letter-spacing', letterSpacing, 'important');
}
if (textTransform && textTransform !== 'initial' && textTransform !== 'inherit' && textTransform !== 'none' && textTransform.trim() !== '') {
button.style.setProperty('text-transform', textTransform, 'important');
}
const textSpan = button.querySelector('.button__text');
if (textSpan) {
if (fontFamily && fontFamily !== 'initial' && fontFamily !== 'inherit' && fontFamily.trim() !== '') {
textSpan.style.setProperty('font-family', fontFamily, 'important');
}
if (fontSize && fontSize !== 'initial' && fontSize !== 'inherit' && fontSize.trim() !== '' && !button.dataset.fontSize) {
textSpan.style.setProperty('font-size', fontSize, 'important');
}
if (fontWeight && fontWeight !== 'initial' && fontWeight !== 'inherit' && fontWeight.trim() !== '') {
textSpan.style.setProperty('font-weight', fontWeight, 'important');
}
if (lineHeight && lineHeight !== 'initial' && lineHeight !== 'inherit' && lineHeight.trim() !== '') {
textSpan.style.setProperty('line-height', lineHeight, 'important');
}
if (letterSpacing && letterSpacing !== 'initial' && letterSpacing !== 'inherit' && letterSpacing.trim() !== '') {
textSpan.style.setProperty('letter-spacing', letterSpacing, 'important');
}
if (textTransform && textTransform !== 'initial' && textTransform !== 'inherit' && textTransform !== 'none' && textTransform.trim() !== '') {
textSpan.style.setProperty('text-transform', textTransform, 'important');
}
}
}
function isProductPage() {
if (isThemeEditor()) {
const productForm = document.querySelector('form[action*="/cart/add"]');
return !!productForm;
}
const pathname = window.location.pathname || '';
const isProductPath = /\/products\//.test(pathname);
if (isProductPath) {
return true;
}
const hasProductForm = !!document.querySelector('form[action*="/cart/add"]');
const hasProductData = !!(window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.id) ||
!!(window.Shopify && window.Shopify.product && window.Shopify.product.id);
return hasProductForm || hasProductData;
}
function positionTryOnButton() {
if (isPositioning) return;
const container = document.getElementById(containerId);
if (!container) return;
const currentUrl = window.location.href;
if (lastPositionedUrl === currentUrl && container.classList.contains('is-positioned') && container.parentElement && container.parentElement !== document.body) {
if (container.style.display === 'none' || window.getComputedStyle(container).display === 'none') {
container.style.display = 'contents';
}
return;
}
isPositioning = true;
try {
if (!isProductPage()) {
container.style.display = 'none';
container.classList.remove('is-positioned');
isPositioning = false;
return;
}
const productId = getProductId();
const button = document.getElementById(buttonId);
if (button) {
// Set product ID if found, otherwise retry after a delay
if (productId) {
button.setAttribute('data-product-id', productId);
} else {
// Retry getting product ID after a delay in case NUSENSE_PRODUCT_DATA loads later
setTimeout(function() {
const retryProductId = getProductId();
if (retryProductId && button) {
button.setAttribute('data-product-id', retryProductId);
}
}, 500);
}
}
const purchaseBoundary = findPurchaseActionBoundary();
if (!purchaseBoundary || !purchaseBoundary.insertParent || !purchaseBoundary.insertTarget || purchaseBoundary.insertParent === document.body || purchaseBoundary.insertParent === document.documentElement) {
container.style.display = 'none';
container.classList.remove('is-positioned');
isPositioning = false;
return;
}
const insertParent = purchaseBoundary.insertParent;
const insertTarget = purchaseBoundary.insertTarget;
const currentParent = container.parentElement;
// If we’re already inserted immediately BEFORE the target, we’re done.
if (currentParent === insertParent && container.nextSibling === insertTarget) {
container.style.display = 'contents';
container.classList.add('is-positioned');
if (button && purchaseBoundary && purchaseBoundary.insertTarget) {
const targetButton = purchaseBoundary.insertTarget.tagName === 'BUTTON' || purchaseBoundary.insertTarget.tagName === 'INPUT' ? purchaseBoundary.insertTarget : (purchaseBoundary.insertTarget.querySelector ? purchaseBoundary.insertTarget.querySelector('button, input[type="submit"]') : null);
if (targetButton) {
setTimeout(function() {
inheritTypographyFromButton(button, targetButton);
}, 100);
}
}
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
}
if (currentParent && currentParent !== document.body) {
container.remove();
}
const insertParentStyle = window.getComputedStyle(insertParent);
const isInsertParentFlexRow = (insertParentStyle.display === 'flex' || insertParentStyle.display === 'inline-flex') && (insertParentStyle.flexDirection === 'row' || insertParentStyle.flexDirection === 'row-reverse' || insertParentStyle.flexDirection === '');
const isInsertParentGrid = insertParentStyle.display === 'grid' && insertParentStyle.gridTemplateColumns !== 'none';
if (purchaseBoundary.isGroup && (isInsertParentFlexRow || isInsertParentGrid)) {
// Ensure we appear ABOVE the primary purchase actions in horizontal layouts.
// Since the wrapper uses `display: contents`, apply layout rules to the button itself.
if (button) {
button.style.width = '100%';
button.style.flexBasis = '100%';
button.style.flexShrink = '0';
button.style.flexGrow = '0';
button.style.clear = 'both';
button.style.order = '-1';
if (isInsertParentFlexRow) {
button.style.minWidth = '100%';
button.style.maxWidth = '100%';
}
if (isInsertParentGrid) {
button.style.gridColumn = '1 / -1';
}
}
}
// Insert above the primary purchase button section (instead of after it).
if (insertTarget && insertTarget.parentElement === insertParent) {
insertParent.insertBefore(container, insertTarget);
} else {
insertParent.appendChild(container);
}
container.style.display = 'contents';
container.classList.add('is-positioned');
// If merchant hasn't set custom margins, inherit the theme's spacing between purchase buttons.
applyThemeSpacingIfUnset(button, insertTarget, insertParent);
if (button && purchaseBoundary && purchaseBoundary.insertTarget) {
const targetButton = purchaseBoundary.insertTarget.tagName === 'BUTTON' || purchaseBoundary.insertTarget.tagName === 'INPUT' ? purchaseBoundary.insertTarget : (purchaseBoundary.insertTarget.querySelector ? purchaseBoundary.insertTarget.querySelector('button, input[type="submit"]') : null);
if (targetButton) {
setTimeout(function() {
inheritTypographyFromButton(button, targetButton);
}, 100);
}
}
lastPositionedUrl = currentUrl;
isPositioning = false;
} catch (e) {
console.error('[NUSENSE] Error positioning button:', e);
if (container) {
container.style.display = 'contents';
container.classList.add('is-positioned');
}
isPositioning = false;
}
}
let positionTimeout = null;
let positionScheduled = false;
let lastPositionRunAt = 0;
const POSITION_THROTTLE_MS = 250;
function schedulePosition() {
if (positionScheduled) return;
positionScheduled = true;
const now = Date.now();
const delay = Math.max(0, POSITION_THROTTLE_MS - (now - lastPositionRunAt));
positionTimeout = setTimeout(function() {
positionScheduled = false;
lastPositionRunAt = Date.now();
if (typeof window.requestIdleCallback === 'function') {
window.requestIdleCallback(function() {
positionTryOnButton();
}, { timeout: 500 });
return;
}
requestAnimationFrame(positionTryOnButton);
}, delay);
}
function initPositioning() {
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', function() {
positionTryOnButton();
requestAnimationFrame(positionTryOnButton);
});
} else {
positionTryOnButton();
requestAnimationFrame(positionTryOnButton);
}
let observer = null;
let observerSetupTimer = null;
let observerSetupAttempts = 0;
const MAX_OBSERVER_SETUP_ATTEMPTS = 20;
const setupObserver = function() {
if (observerSetupTimer) {
clearTimeout(observerSetupTimer);
observerSetupTimer = null;
}
try {
if (observer) observer.disconnect();
} catch (e) {}
observer = null;
const productForm = document.querySelector('form[action*="/cart/add"]');
if (!productForm) {
observerSetupAttempts += 1;
if (observerSetupAttempts <= MAX_OBSERVER_SETUP_ATTEMPTS) {
observerSetupTimer = setTimeout(setupObserver, Math.min(1000, 100 + observerSetupAttempts * 50));
}
return;
}
observerSetupAttempts = 0;
const purchaseBoundary = findPurchaseActionBoundary();
const target =
  purchaseBoundary && purchaseBoundary.insertParent
    ? purchaseBoundary.insertParent
    : (productForm.parentElement && productForm.parentElement !== document.body ? productForm.parentElement : productForm);

function isRelevantPurchaseMutationNode(node) {
  if (!node || node.nodeType !== 1) return false;
  const el = node;

  // If our container is being inserted/removed/moved, re-position.
  try {
    if (el.id === containerId) return true;
    if (el.querySelector && el.querySelector('#' + CSS.escape(containerId))) return true;
  } catch (e) {}

  // Only react to purchase-related button changes; ignore stock alerts and other UI updates.
  try {
    if (el.matches && el.matches('.shopify-payment-button, .shopify-payment-button__button, [data-shopify="payment-button"]')) return true;
    if (el.matches && el.matches('button[type="submit"], input[type="submit"], button[name="add"], [name="add"]')) return true;
    if (el.querySelector && el.querySelector('.shopify-payment-button, .shopify-payment-button__button, [data-shopify="payment-button"]')) return true;
    if (el.querySelector && el.querySelector('button[type="submit"], input[type="submit"], button[name="add"], [name="add"]')) return true;
  } catch (e) {}

  return false;
}

observer = new MutationObserver(function(mutations) {
  for (const mutation of mutations) {
    if (mutation.type !== 'childList') continue;
    const nodes = [];
    try {
      if (mutation.addedNodes && mutation.addedNodes.length) nodes.push.apply(nodes, mutation.addedNodes);
      if (mutation.removedNodes && mutation.removedNodes.length) nodes.push.apply(nodes, mutation.removedNodes);
    } catch (e) {}

    if (nodes.some(isRelevantPurchaseMutationNode)) {
      schedulePosition();
      break;
    }
  }
});

// Important: avoid attributes observation (disabled/type changes can be extremely chatty and slow).
// Also keep scope tight to the purchase group container to avoid reacting to unrelated DOM churn (e.g., stock alerts).
observer.observe(target, {childList: true, subtree: true});
};
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', setupObserver, { once: true });
} else {
setupObserver();
}
document.addEventListener('shopify:section:load', function() {
setupObserver();
schedulePosition();
});
document.addEventListener('shopify:section:reorder', function() {
setupObserver();
schedulePosition();
});
let lastUrl = window.location.href;
window.addEventListener('popstate', function() {
if (window.location.href !== lastUrl) {
lastUrl = window.location.href;
lastPositionedUrl = null;
setupObserver();
schedulePosition();
}
});
}
initPositioning();
})();</script>



