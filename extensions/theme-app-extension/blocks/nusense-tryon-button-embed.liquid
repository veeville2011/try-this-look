

{% render 'nusense-tryon-script' %}

<style>.nusense-tryon-button{display:inline-flex !important;align-items:center !important;justify-content:center !important;gap:0.5rem;padding:0.75rem 1.5rem !important;font-size:1rem !important;font-weight:500 !important;text-align:center;text-decoration:none;cursor:pointer !important;border:1px solid transparent;border-radius:4px;transition:all 0.2s cubic-bezier(0.4,0,0.2,1) !important;min-height:44px !important;box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;user-select:none;-webkit-user-select:none;touch-action:manipulation;will-change:transform,box-shadow;}.nusense-tryon-button.button--primary,.nusense-tryon-button.btn-primary,.nusense-tryon-button.btn--primary,.nusense-tryon-button.button,.nusense-tryon-button.btn{background-color:#000000 !important;color:#ffffff !important;border-color:#000000 !important;box-shadow:0 2px 4px rgba(0,0,0,0.1),0 1px 2px rgba(0,0,0,0.06) !important;font-weight:600 !important;letter-spacing:0.01em;}.nusense-tryon-button.button--primary:hover,.nusense-tryon-button.btn-primary:hover,.nusense-tryon-button.btn--primary:hover,.nusense-tryon-button.button:hover,.nusense-tryon-button.btn:hover{background-color:#1a1a1a !important;border-color:#1a1a1a !important;box-shadow:0 4px 6px rgba(0,0,0,0.15),0 2px 4px rgba(0,0,0,0.1) !important;transform:translateY(-1px);opacity:1 !important;}.nusense-tryon-button.button--primary:focus,.nusense-tryon-button.btn-primary:focus,.nusense-tryon-button.btn--primary:focus,.nusense-tryon-button.button:focus,.nusense-tryon-button.btn:focus{outline:2px solid #ffffff !important;outline-offset:2px !important;box-shadow:0 0 0 3px rgba(0,0,0,0.2),0 4px 6px rgba(0,0,0,0.15) !important;}.nusense-tryon-button.button--primary:active,.nusense-tryon-button.btn-primary:active,.nusense-tryon-button.btn--primary:active,.nusense-tryon-button.button:active,.nusense-tryon-button.btn:active{background-color:#0d0d0d !important;border-color:#0d0d0d !important;box-shadow:0 1px 2px rgba(0,0,0,0.2) !important;transform:translateY(0);}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]){background-color:#000000 !important;color:#ffffff !important;border-color:#000000 !important;box-shadow:0 2px 4px rgba(0,0,0,0.1),0 1px 2px rgba(0,0,0,0.06) !important;font-weight:600 !important;letter-spacing:0.01em;text-transform:none;position:relative;overflow:hidden;}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):hover{background-color:#1a1a1a !important;border-color:#1a1a1a !important;box-shadow:0 4px 6px rgba(0,0,0,0.15),0 2px 4px rgba(0,0,0,0.1) !important;transform:translateY(-1px);opacity:1 !important;}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):focus{outline:2px solid #ffffff !important;outline-offset:2px !important;box-shadow:0 0 0 3px rgba(0,0,0,0.2),0 4px 6px rgba(0,0,0,0.15) !important;}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):focus:not(:focus-visible){outline:none !important;}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"]):active{background-color:#0d0d0d !important;border-color:#0d0d0d !important;box-shadow:0 1px 2px rgba(0,0,0,0.2) !important;transform:translateY(0);}.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"])[disabled],.nusense-tryon-button:not([class*="button--secondary"]):not([class*="btn-secondary"]):not([class*="button--outline"]):not([class*="btn-outline"]):not([class*="button--tertiary"]):not([class*="btn-link"])[aria-disabled="true"]{background-color:#666666 !important;border-color:#666666 !important;color:#ffffff !important;cursor:not-allowed !important;opacity:0.6 !important;box-shadow:none !important;transform:none !important;}.nusense-tryon-button.button--secondary,.nusense-tryon-button.btn-secondary,.nusense-tryon-button.btn--secondary{background-color:#f5f5f5 !important;color:#000000 !important;border:1px solid #e0e0e0 !important;box-shadow:0 1px 2px rgba(0,0,0,0.05) !important;}.nusense-tryon-button.button--secondary:hover,.nusense-tryon-button.btn-secondary:hover,.nusense-tryon-button.btn--secondary:hover{background-color:#e8e8e8 !important;box-shadow:0 2px 4px rgba(0,0,0,0.1) !important;}.nusense-tryon-button.button--outline,.nusense-tryon-button.btn-outline,.nusense-tryon-button.btn--outline{background-color:transparent !important;color:#000000 !important;border:2px solid #000000 !important;box-shadow:none !important;}.nusense-tryon-button.button--outline:hover,.nusense-tryon-button.btn-outline:hover,.nusense-tryon-button.btn--outline:hover{background-color:#000000 !important;color:#ffffff !important;box-shadow:0 2px 4px rgba(0,0,0,0.1) !important;}.nusense-tryon-button.button--tertiary,.nusense-tryon-button.btn-link,.nusense-tryon-button.btn--link{background-color:transparent !important;color:#000000 !important;border:1px solid transparent !important;box-shadow:none !important;text-decoration:none !important;}.nusense-tryon-button.button--tertiary:hover,.nusense-tryon-button.btn-link:hover,.nusense-tryon-button.btn--link:hover{background-color:rgba(0,0,0,0.05) !important;text-decoration:underline !important;}.nusense-tryon-button.button--full-width,.nusense-tryon-button.btn-block,.nusense-tryon-button.btn--full-width{width:100% !important;}.nusense-tryon-button .button__text{color:inherit !important;}.nusense-tryon-button[style*="display:none"]{display:inline-flex !important;}.nusense-tryon-button[data-loading="true"]{opacity:0.7;pointer-events:none;}.nusense-widget-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;}.nusense-widget-container{position:relative;width:95vw;max-width:1200px;height:90vh;}.nusense-widget-close{position:absolute;top:-40px;right:0;background:white;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:24px;line-height:1;z-index:10000;display:flex;align-items:center;justify-content:center;}.nusense-widget-close:hover{background:#f0f0f0;}.nusense-widget-close:focus{outline:2px solid #007bff;outline-offset:2px;}.nusense-tryon-button-embed-container{position:static;float:none;width:100%;margin-bottom:0.75rem;z-index:auto;opacity:0;visibility:hidden;}.nusense-tryon-button-embed-container.is-positioned{opacity:1;visibility:visible;display:block !important;}</style>

{% schema %}
{
  "name": "NUSENSE Try-On Button",
  "target": "body",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Try Now"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "minimal",
          "label": "Minimal"
        }
      ],
      "default": "primary"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show Icon",
      "default": true
    },
    {
      "type": "text",
      "id": "button_icon",
      "label": "Button Icon (emoji)",
      "default": "âœ¨"
    },
    {
      "type": "checkbox",
      "id": "button_width_full",
      "label": "Full Width Button",
      "default": true,
      "info": "Enable to make button full width. Disable to allow flexible width (can be placed next to other buttons)"
    },
    {
      "type": "header",
      "content": "Positioning & Spacing"
    },
    {
      "type": "paragraph",
      "content": "The button will automatically appear on all product pages. Use the spacing settings below to adjust margins around the button."
    },
    {
      "type": "select",
      "id": "button_alignment",
      "label": "Button Alignment",
      "options": [
        {
          "value": "auto",
          "label": "Auto (Match Theme)"
        },
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "auto",
      "info": "Horizontal alignment of the button. 'Auto' matches the Add to Cart button alignment."
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space above the button"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space below the button (spacing before Add to Cart button)"
    },
    {
      "type": "range",
      "id": "margin_left",
      "label": "Left Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the left of the button"
    },
    {
      "type": "range",
      "id": "margin_right",
      "label": "Right Margin (rem)",
      "min": 0,
      "max": 5,
      "step": 0.2,
      "default": 0,
      "unit": "rem",
      "info": "Space to the right of the button"
    },
    {
      "type": "header",
      "content": "Advanced Customization"
    },
    {
      "type": "color",
      "id": "button_background_color",
      "label": "Button Background Color",
      "info": "Override theme colors with a custom background color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "info": "Override theme colors with a custom text color. Leave empty to use theme colors."
    },
    {
      "type": "color",
      "id": "button_border_color",
      "label": "Button Border Color",
      "info": "Override theme colors with a custom border color. Leave empty to use theme colors."
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Font Size (px)",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px",
      "info": "Customize button font size"
    },
    {
      "type": "range",
      "id": "button_padding",
      "label": "Padding (rem)",
      "min": 0.2,
      "max": 3,
      "step": 0.2,
      "default": 0.8,
      "unit": "rem",
      "info": "Customize button padding"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Border Radius (px)",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 4,
      "unit": "px",
      "info": "Customize button border radius"
    },
    {
      "type": "text",
      "id": "custom_css",
      "label": "Custom CSS",
      "info": "Add custom CSS to further customize the button. Use selector: .nusense-tryon-button",
      "placeholder": ".nusense-tryon-button { /* your styles */ }"
    }
  ]
}
{% endschema %}

{% assign button_text = block.settings.button_text | default: 'Try Now' %}
{% assign button_style = block.settings.button_style | default: 'primary' %}
{% assign button_icon = block.settings.button_icon | default: 'âœ¨' %}
{% assign button_background_color = block.settings.button_background_color %}
{% assign button_text_color = block.settings.button_text_color %}
{% assign button_border_color = block.settings.button_border_color %}
{% assign button_font_size = block.settings.button_font_size | default: 16 %}
{% assign button_padding = block.settings.button_padding | default: 0.8 %}
{% assign button_border_radius = block.settings.button_border_radius | default: 4 %}
{% assign button_alignment = block.settings.button_alignment | default: 'auto' %}
{% assign margin_top = block.settings.margin_top | default: 0 %}
{% assign margin_bottom = block.settings.margin_bottom | default: 0 %}
{% assign margin_left = block.settings.margin_left | default: 0 %}
{% assign margin_right = block.settings.margin_right | default: 0 %}
{% assign custom_css = block.settings.custom_css %}

{% if block.settings.show_icon == true or block.settings.show_icon == 'true' %}
  {% assign show_icon = true %}
{% else %}
  {% assign show_icon = false %}
{% endif %}

{% if block.settings.button_width_full == true or block.settings.button_width_full == 'true' %}
  {% assign button_width_full = true %}
{% else %}
  {% assign button_width_full = false %}
{% endif %}

{% assign button_classes = 'button nusense-tryon-button' %}
{% case button_style %}
  {% when 'secondary' %}
    {% assign button_classes = button_classes | append: ' button--secondary' %}
  {% when 'outline' %}
    {% assign button_classes = button_classes | append: ' button--outline' %}
  {% when 'minimal' %}
    {% assign button_classes = button_classes | append: ' button--tertiary' %}
  {% else %}
    {% assign button_classes = button_classes | append: ' button--primary' %}
{% endcase %}
{% if button_width_full %}
  {% assign button_classes = button_classes | append: ' button--full-width' %}
{% endif %}

<div 
  id="nusense-tryon-button-embed-{{ block.id }}" 
  class="nusense-tryon-button-embed-container"
  data-block-id="{{ block.id }}"
  data-button-text="{{ button_text }}"
  data-button-style="{{ button_style }}"
  data-button-icon="{{ button_icon }}"
  data-show-icon="{{ show_icon }}"
  data-button-width-full="{{ button_width_full }}"
  data-button-classes="{{ button_classes }}"
  data-button-alignment="{{ button_alignment }}"
  data-margin-top="{{ margin_top }}"
  data-margin-bottom="{{ margin_bottom }}"
  data-margin-left="{{ margin_left }}"
  data-margin-right="{{ margin_right }}"
  {% if button_background_color != blank %}data-background-color="{{ button_background_color }}"{% endif %}
  {% if button_text_color != blank %}data-text-color="{{ button_text_color }}"{% endif %}
  {% if button_border_color != blank %}data-border-color="{{ button_border_color }}"{% endif %}
  {% if button_font_size != blank %}data-font-size="{{ button_font_size }}"{% endif %}
  {% if button_padding != blank %}data-padding="{{ button_padding }}"{% endif %}
  {% if button_border_radius != blank %}data-border-radius="{{ button_border_radius }}"{% endif %}
  {% if custom_css != blank %}data-custom-css="{{ custom_css }}"{% endif %}
  data-widget-url="{{ shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' }}"
  data-shop-domain="{{ shop.permanent_domain }}"
>
  <button 
    id="nusense-tryon-btn-{{ block.id }}" 
    class="{{ button_classes }}"
    aria-label="{{ button_text }}"
    data-product-id=""
    data-shop-domain="{{ shop.permanent_domain }}"
    data-button-style="{{ button_style }}"
    data-show-icon="{{ show_icon }}"
    data-button-width-full="{{ button_width_full }}"
    {% if button_background_color != blank %}data-background-color="{{ button_background_color }}"{% endif %}
    {% if button_text_color != blank %}data-text-color="{{ button_text_color }}"{% endif %}
    {% if button_border_color != blank %}data-border-color="{{ button_border_color }}"{% endif %}
    {% if button_font_size != blank %}data-font-size="{{ button_font_size }}"{% endif %}
    {% if button_padding != blank %}data-padding="{{ button_padding }}"{% endif %}
    {% if button_border_radius != blank %}data-border-radius="{{ button_border_radius }}"{% endif %}
    data-alignment="{{ button_alignment }}"
    data-margin-top="{{ margin_top }}"
    data-margin-bottom="{{ margin_bottom }}"
    data-margin-left="{{ margin_left }}"
    data-margin-right="{{ margin_right }}"
    data-button-icon="{{ button_icon }}"
    {% if custom_css != blank %}data-custom-css="{{ custom_css }}"{% endif %}
    data-widget-url="{{ shop.metafields.nusense.widget_url | default: 'https://try-this-look.vercel.app' }}"
    data-loading="true"
    style="display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;{% if button_width_full %} width: 100%;{% endif %}"
  >
    <span class="button__icon" data-icon="{{ button_icon }}" aria-hidden="true" style="{% unless show_icon %}display: none;{% endunless %}">{{ button_icon }}</span>
    <span class="button__text" id="nusense-tryon-desc-{{ block.id }}">{{ button_text }}</span>
  </button>
</div>

<script src="{{ 'nusense-tryon-button.js' | asset_url }}" defer></script>

<script>(function() {
'use strict';
const blockId = '{{ block.id }}';
const containerId = 'nusense-tryon-button-embed-' + blockId;
const buttonId = 'nusense-tryon-btn-' + blockId;
let isPositioning = false;
let lastPositionedUrl = null;
function isElementVisible(element) {
if (!element) return false;
const style = window.getComputedStyle(element);
if (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity) < 0.1) {
return false;
}
if (element.disabled === true || element.hasAttribute('disabled')) {
return false;
}
if (element.offsetWidth === 0 && element.offsetHeight === 0 && style.position !== 'absolute' && style.position !== 'fixed') {
return false;
}
let parent = element.parentElement;
while (parent && parent !== document.body) {
const parentStyle = window.getComputedStyle(parent);
const parentId = String(parent.getAttribute('id') || parent.id || '');
const parentClass = String(parent.className || (parent.classList ? Array.from(parent.classList).join(' ') : ''));
if (parentStyle.display === 'none' ||
parentStyle.visibility === 'hidden' ||
(typeof parentId === 'string' && (parentId.includes('drawer') || parentId.includes('modal') || parentId.includes('popup') || parentId.includes('quick-view'))) ||
(typeof parentClass === 'string' && (parentClass.includes('drawer') || parentClass.includes('modal') || parentClass.includes('popup') || parentClass.includes('quick-view')))) {
return false;
}
parent = parent.parentElement;
}
return true;
}
function findProductPurchaseBoundary() {
console.log('[NUSENSE] ===== STEP 1: Locate Product Purchase Boundary (Invariant) =====');
const productForm = document.querySelector('form[action*="/cart/add"]');
if (!productForm) {
console.log('[NUSENSE] STEP 1: âŒ Product form not found. Aborting positioning.');
return null;
}
console.log('[NUSENSE] STEP 1: âœ… Found product form:', productForm);
console.log('[NUSENSE] STEP 1: Form action:', productForm.action);
console.log('[NUSENSE] STEP 1: Form ID:', productForm.id || '(none)');
console.log('[NUSENSE] STEP 1: Form class:', productForm.className || '(none)');
return productForm;
}
function findPrimarySubmitControl(productForm) {
console.log('[NUSENSE] ===== STEP 2: Locate Primary Submit Control (Add to Cart) =====');
if (!productForm) {
console.log('[NUSENSE] STEP 2: âŒ No product form provided. Aborting.');
return null;
}
const submitButton = productForm.querySelector('button[type="submit"], input[type="submit"]');
if (!submitButton) {
console.log('[NUSENSE] STEP 2: âŒ No submit button found in form. Aborting safely.');
console.log('[NUSENSE] STEP 2: Form HTML preview:', productForm.outerHTML.substring(0, 500));
return null;
}
console.log('[NUSENSE] STEP 2: âœ… Found primary submit button:', submitButton);
console.log('[NUSENSE] STEP 2: Button type:', submitButton.type);
console.log('[NUSENSE] STEP 2: Button tag:', submitButton.tagName);
console.log('[NUSENSE] STEP 2: Button ID:', submitButton.id || '(none)');
console.log('[NUSENSE] STEP 2: Button class:', submitButton.className || '(none)');
console.log('[NUSENSE] STEP 2: Button text:', (submitButton.textContent || submitButton.value || '').trim().substring(0, 50));
return submitButton;
}
function detectButtonGroup(submitButton) {
console.log('[NUSENSE] ===== STEP 3: Detect Button Group vs Single Button =====');
if (!submitButton) {
console.log('[NUSENSE] STEP 3: âŒ No submit button provided. Aborting.');
return null;
}
console.log('[NUSENSE] STEP 3: Finding nearest shared container...');
const buttonGroup = submitButton.closest('div, section, fieldset');
if (!buttonGroup) {
console.log('[NUSENSE] STEP 3: âš ï¸ No container found (div/section/fieldset). Using button parent.');
const buttonParent = submitButton.parentElement;
console.log('[NUSENSE] STEP 3: Button parent:', buttonParent);
console.log('[NUSENSE] STEP 3: Button parent tag:', buttonParent.tagName);
return {isGroup: false, container: buttonParent, submitButton: submitButton};
}
console.log('[NUSENSE] STEP 3: âœ… Found container:', buttonGroup);
console.log('[NUSENSE] STEP 3: Container tag:', buttonGroup.tagName);
console.log('[NUSENSE] STEP 3: Container ID:', buttonGroup.id || '(none)');
console.log('[NUSENSE] STEP 3: Container class:', buttonGroup.className || '(none)');
const submitButtonsInGroup = buttonGroup.querySelectorAll('button[type="submit"], input[type="submit"]');
const visibleSubmitButtons = Array.from(submitButtonsInGroup).filter(btn => isElementVisible(btn));
console.log('[NUSENSE] STEP 3: Total submit buttons in container:', submitButtonsInGroup.length);
console.log('[NUSENSE] STEP 3: Visible submit buttons:', visibleSubmitButtons.length);
visibleSubmitButtons.forEach((btn, idx) => {
console.log('[NUSENSE] STEP 3:   Button', idx + 1, ':', btn.tagName, btn.type, '-', (btn.textContent || btn.value || '').trim().substring(0, 30));
});
if (visibleSubmitButtons.length === 1) {
console.log('[NUSENSE] STEP 3: âœ… CASE A: Single submit button detected');
console.log('[NUSENSE] STEP 3: Placement rule: Place Try On button ABOVE the submit button');
return {isGroup: false, container: submitButton.parentElement, submitButton: submitButton};
} else if (visibleSubmitButtons.length >= 2) {
console.log('[NUSENSE] STEP 3: âœ… CASE B: Multiple submit buttons detected (', visibleSubmitButtons.length, 'buttons)');
console.log('[NUSENSE] STEP 3: Placement rule: Place Try On button ABOVE THE ENTIRE BUTTON GROUP');
console.log('[NUSENSE] STEP 3: Button group container:', buttonGroup);
return {isGroup: true, container: buttonGroup, submitButton: submitButton, allButtons: visibleSubmitButtons};
}
console.log('[NUSENSE] STEP 3: âš ï¸ Unexpected state. Using single button logic.');
return {isGroup: false, container: submitButton.parentElement, submitButton: submitButton};
}
function findActionButtonPosition() {
console.log('[NUSENSE] ========================================');
console.log('[NUSENSE] STARTING POSITIONING LOGIC');
console.log('[NUSENSE] ========================================');
const productForm = findProductPurchaseBoundary();
if (!productForm) {
console.log('[NUSENSE] âŒ Cannot proceed: No product form found');
return null;
}
const submitButton = findPrimarySubmitControl(productForm);
if (!submitButton) {
console.log('[NUSENSE] âŒ Cannot proceed: No submit button found');
return null;
}
const buttonGroupInfo = detectButtonGroup(submitButton);
if (!buttonGroupInfo) {
console.log('[NUSENSE] âŒ Cannot proceed: Could not detect button group');
return null;
}
console.log('[NUSENSE] ========================================');
console.log('[NUSENSE] POSITIONING DECISION:', buttonGroupInfo.isGroup ? 'BUTTON GROUP' : 'SINGLE BUTTON');
console.log('[NUSENSE] ========================================');
return buttonGroupInfo;
}
function getProductId() {
if (window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.id) {
return window.NUSENSE_PRODUCT_DATA.id;
}
if (window.Shopify && window.Shopify.product && window.Shopify.product.id) {
return window.Shopify.product.id;
}
try {
const jsonScripts = document.querySelectorAll('script[type="application/json"]');
for (let script of jsonScripts) {
try {
const data = JSON.parse(script.textContent);
if (data.product && data.product.id) {
return data.product.id;
}
} catch (e) {
}
}
} catch (e) {
}
return null;
}
function isProductPage() {
const pathname = window.location.pathname || '';
const isProductPath = /\/products\//.test(pathname);
if (isProductPath) {
return true;
}
const hasProductForm = !!document.querySelector('form[action*="/cart/add"]');
const hasProductData = !!(window.NUSENSE_PRODUCT_DATA && window.NUSENSE_PRODUCT_DATA.id) ||
!!(window.Shopify && window.Shopify.product && window.Shopify.product.id);
const hasProductIndicators = !!(
document.querySelector('[data-product-id]') ||
document.querySelector('.product') ||
document.querySelector('.product-single') ||
document.querySelector('.product__info') ||
document.querySelector('[data-product]') ||
document.querySelector('script[type="application/ld+json"]')
);
return hasProductForm || hasProductData || hasProductIndicators;
}
function positionTryOnButton() {
console.log('[NUSENSE] ========================================');
console.log('[NUSENSE] POSITION TRY ON BUTTON - START');
console.log('[NUSENSE] ========================================');
if (isPositioning) {
console.log('[NUSENSE] âš ï¸ Already positioning, skipping...');
return;
}
const container = document.getElementById(containerId);
if (!container) {
console.warn('[NUSENSE] âŒ Container not found:', containerId);
return;
}
console.log('[NUSENSE] âœ… Container found:', container);
console.log('[NUSENSE] Safety Guard: Checking if already inserted...');
if (container.parentElement && container.parentElement !== document.body) {
console.log('[NUSENSE] Safety Guard: Container already has parent:', container.parentElement);
console.log('[NUSENSE] Safety Guard: Will reposition if needed');
}
const currentUrl = window.location.href;
console.log('[NUSENSE] Current URL:', currentUrl);
console.log('[NUSENSE] Last positioned URL:', lastPositionedUrl);
if (lastPositionedUrl === currentUrl && container.parentElement && container.parentElement !== document.body && container.classList.contains('is-positioned')) {
console.log('[NUSENSE] âœ… Already positioned for this URL');
if (container.style.display === 'none' || window.getComputedStyle(container).display === 'none') {
console.log('[NUSENSE] Container hidden, making visible');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
}
return;
}
isPositioning = true;
console.log('[NUSENSE] âœ… Starting positioning process...');
try {
console.log('[NUSENSE] Checking if product page...');
if (!isProductPage()) {
console.log('[NUSENSE] âŒ Not a product page. Hiding container.');
container.style.display = 'none';
container.style.visibility = 'hidden';
container.style.opacity = '0';
container.classList.remove('is-positioned');
isPositioning = false;
return;
}
console.log('[NUSENSE] âœ… Confirmed: Product page');
const productId = getProductId();
console.log('[NUSENSE] Product ID:', productId || '(not found)');
const button = document.getElementById(buttonId);
if (button && productId) {
button.setAttribute('data-product-id', productId);
console.log('[NUSENSE] âœ… Set product ID on button');
}
container.classList.add('is-product-page');
console.log('[NUSENSE] ===== STEP 4: Execute Placement Rule =====');
const buttonPosition = findActionButtonPosition();
if (buttonPosition && buttonPosition.container) {
console.log('[NUSENSE] STEP 4: âœ… Button position detected');
console.log('[NUSENSE] STEP 4: Is group:', buttonPosition.isGroup);
console.log('[NUSENSE] STEP 4: Target container:', buttonPosition.container);
console.log('[NUSENSE] STEP 4: Target container tag:', buttonPosition.container.tagName);
const targetContainer = buttonPosition.container;
const currentParent = container.parentElement;
console.log('[NUSENSE] STEP 4: Current container parent:', currentParent);
console.log('[NUSENSE] STEP 4: Current container next sibling:', container.nextSibling);
if (buttonPosition.isGroup) {
console.log('[NUSENSE] STEP 4: ðŸ“ CASE B: Multiple buttons - Placing above button group');
const buttonGroup = buttonPosition.container;
const firstButtonInGroup = buttonPosition.submitButton;
console.log('[NUSENSE] STEP 4: Button group:', buttonGroup);
console.log('[NUSENSE] STEP 4: First button in group:', firstButtonInGroup);
if (currentParent === buttonGroup.parentElement && container.nextSibling === buttonGroup) {
console.log('[NUSENSE] STEP 4: âœ… Already positioned correctly above button group');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
}
if (buttonGroup.parentElement && buttonGroup.parentElement !== document.body) {
console.log('[NUSENSE] STEP 4: Inserting container before button group');
buttonGroup.parentElement.insertBefore(container, buttonGroup);
console.log('[NUSENSE] STEP 4: âœ… Successfully placed above button group');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
if (!container.style.marginBottom || container.style.marginBottom === '') {
container.style.marginBottom = '0.75rem';
console.log('[NUSENSE] STEP 4: Applied margin-bottom: 0.75rem');
}
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
} else {
console.log('[NUSENSE] STEP 4: âš ï¸ Button group parent is body or null, cannot place above group');
}
} else {
console.log('[NUSENSE] STEP 4: ðŸ“ CASE A: Single button - Placing above submit button');
const submitButton = buttonPosition.submitButton;
const buttonParent = submitButton.parentElement;
console.log('[NUSENSE] STEP 4: Submit button:', submitButton);
console.log('[NUSENSE] STEP 4: Button parent:', buttonParent);
console.log('[NUSENSE] STEP 4: Button parent tag:', buttonParent.tagName);
if (currentParent === buttonParent && container.nextSibling === submitButton) {
console.log('[NUSENSE] STEP 4: âœ… Already positioned correctly above submit button');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
}
if (buttonParent && buttonParent !== document.body) {
console.log('[NUSENSE] STEP 4: Inserting container before submit button');
buttonParent.insertBefore(container, submitButton);
console.log('[NUSENSE] STEP 4: âœ… Successfully placed above submit button');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
if (!container.style.marginBottom || container.style.marginBottom === '') {
container.style.marginBottom = '0.75rem';
console.log('[NUSENSE] STEP 4: Applied margin-bottom: 0.75rem');
}
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
} else {
console.log('[NUSENSE] STEP 4: âš ï¸ Button parent is body or null, cannot place above button');
}
}
}
console.log('[NUSENSE] ===== STEP 5: Fallback Positioning =====');
console.warn('[NUSENSE] STEP 5: Action button position not found, using fallback positioning');
console.log('[NUSENSE] STEP 5: Attempting fallback to product form parent...');
const productForm = document.querySelector('form[action*="/cart/add"]');
if (productForm && container.parentElement !== productForm.parentElement) {
console.log('[NUSENSE] STEP 5: âœ… Found product form for fallback');
const formParent = productForm.parentElement;
console.log('[NUSENSE] STEP 5: Form parent:', formParent);
if (formParent && formParent !== document.body) {
console.log('[NUSENSE] STEP 5: Placing before product form');
formParent.insertBefore(container, productForm);
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
console.log('[NUSENSE] STEP 5: âœ… Fallback positioning successful');
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
} else {
console.log('[NUSENSE] STEP 5: âš ï¸ Form parent is body or null');
}
} else {
console.log('[NUSENSE] STEP 5: âš ï¸ Product form not found or already in correct parent');
}
console.log('[NUSENSE] STEP 5: Attempting fallback to main content...');
if (container.parentElement === document.body || !container.parentElement) {
const mainContent = document.querySelector('main') ||
document.querySelector('#MainContent') ||
document.querySelector('[role="main"]');
if (mainContent && mainContent !== document.body) {
console.log('[NUSENSE] STEP 5: âœ… Found main content:', mainContent);
mainContent.appendChild(container);
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
console.log('[NUSENSE] STEP 5: âœ… Fallback to main content successful');
lastPositionedUrl = currentUrl;
isPositioning = false;
return;
} else {
console.log('[NUSENSE] STEP 5: âš ï¸ Main content not found');
}
}
console.log('[NUSENSE] STEP 5: âš ï¸ All fallbacks failed. Using default positioning.');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
isPositioning = false;
console.log('[NUSENSE] ========================================');
console.log('[NUSENSE] POSITIONING COMPLETE');
console.log('[NUSENSE] ========================================');
return;
} catch (e) {
console.error('[NUSENSE] ========================================');
console.error('[NUSENSE] âŒ ERROR POSITIONING BUTTON');
console.error('[NUSENSE] ========================================');
console.error('[NUSENSE] Error:', e);
console.error('[NUSENSE] Error message:', e.message);
console.error('[NUSENSE] Error stack:', e.stack);
const container = document.getElementById(containerId);
if (container) {
console.log('[NUSENSE] Applying error fallback: Making container visible');
container.style.display = 'block';
container.style.visibility = 'visible';
container.style.opacity = '1';
container.classList.add('is-positioned');
}
} finally {
isPositioning = false;
console.log('[NUSENSE] Positioning flag reset');
}
}
let positionTimeout = null;
function debouncedPosition() {
if (positionTimeout) {
clearTimeout(positionTimeout);
}
positionTimeout = setTimeout(function() {
positionTryOnButton();
}, 150);
}
function initPositioning() {
if (document.readyState === 'complete' || document.readyState === 'interactive') {
positionTryOnButton();
}
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', function() {
positionTryOnButton();
});
}
const retryDelays = [100, 300, 500, 1000, 2000, 3000];
retryDelays.forEach(function(delay) {
setTimeout(function() {
positionTryOnButton();
}, delay);
});
const observer = new MutationObserver(function(mutations) {
console.log('[NUSENSE] MutationObserver: Detected', mutations.length, 'mutation(s)');
let shouldReposition = false;
for (const mutation of mutations) {
if (mutation.type === 'childList') {
console.log('[NUSENSE] MutationObserver: childList mutation detected');
for (const node of mutation.addedNodes) {
if (node.nodeType === 1) {
console.log('[NUSENSE] MutationObserver: Added node:', node.tagName);
if (node.tagName === 'FORM' && node.action && node.action.includes('/cart/add')) {
console.log('[NUSENSE] MutationObserver: âœ… Product form added, triggering reposition');
shouldReposition = true;
break;
}
if (node.tagName === 'BUTTON' || node.tagName === 'INPUT') {
const form = node.closest('form[action*="/cart/add"]');
if (form) {
console.log('[NUSENSE] MutationObserver: âœ… Button/Input added to product form, triggering reposition');
shouldReposition = true;
break;
}
}
if (node.tagName === 'FORM' || (node.querySelector && node.querySelector('form[action*="/cart/add"]'))) {
console.log('[NUSENSE] MutationObserver: âœ… Form or form container added, triggering reposition');
shouldReposition = true;
break;
}
}
}
}
if (mutation.type === 'attributes') {
console.log('[NUSENSE] MutationObserver: attributes mutation detected on:', mutation.target.tagName);
const target = mutation.target;
if (target.tagName === 'FORM' || target.tagName === 'BUTTON' || target.tagName === 'INPUT') {
const form = target.closest('form[action*="/cart/add"]');
if (form) {
console.log('[NUSENSE] MutationObserver: âœ… Attribute changed on product form element, triggering reposition');
shouldReposition = true;
break;
}
}
}
}
if (shouldReposition) {
console.log('[NUSENSE] MutationObserver: Triggering debounced reposition');
debouncedPosition();
}
});
if (document.body) {
observer.observe(document.body, {
childList: true,
subtree: true,
attributes: true,
attributeFilter: ['action', 'type', 'name', 'disabled', 'data-add-to-cart']
});
} else {
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', function() {
if (document.body) {
observer.observe(document.body, {
childList: true,
subtree: true,
attributes: true,
attributeFilter: ['action', 'type', 'name', 'disabled', 'data-add-to-cart']
});
}
});
}
}
let lastUrl = window.location.href;
let urlCheckIntervalId = null;
let urlCheckCount = 0;
const INITIAL_CHECK_INTERVAL = 500;
const STABLE_CHECK_INTERVAL = 3000;
const MAX_CHECKS_BEFORE_STABLE = 20;
const checkUrlChange = function() {
if (window.location.href !== lastUrl) {
lastUrl = window.location.href;
lastPositionedUrl = null;
urlCheckCount = 0;
if (urlCheckIntervalId) {
clearInterval(urlCheckIntervalId);
}
startUrlChecking();
setTimeout(positionTryOnButton, 300);
}
};
window.addEventListener('popstate', checkUrlChange);
function startUrlChecking() {
urlCheckCount = 0;
function performCheck() {
checkUrlChange();
urlCheckCount++;
if (urlCheckCount >= MAX_CHECKS_BEFORE_STABLE && urlCheckIntervalId) {
clearInterval(urlCheckIntervalId);
urlCheckIntervalId = setInterval(performCheck, STABLE_CHECK_INTERVAL);
}
}
urlCheckIntervalId = setInterval(performCheck, INITIAL_CHECK_INTERVAL);
}
startUrlChecking();
}
initPositioning();
if (document.body) {
positionTryOnButton();
}
window.addEventListener('load', function() {
setTimeout(positionTryOnButton, 100);
});
})();</script>

