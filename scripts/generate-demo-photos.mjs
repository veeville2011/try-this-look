import fs from "node:fs";
import path from "node:path";

const IMAGE_EXTENSIONS = new Set([".jpg", ".jpeg", ".png", ".webp", ".gif", ".avif"]);

const projectRoot = process.cwd();
const demoPicsDir = path.join(projectRoot, "public", "assets", "demo_pics");
const outFile = path.join(projectRoot, "src", "constants", "demoPhotos.generated.ts");

const getDemoFiles = async () => {
  try {
    const entries = await fs.promises.readdir(demoPicsDir, { withFileTypes: true });
    return entries
      .filter((e) => e.isFile())
      .map((e) => e.name)
      .filter((name) => IMAGE_EXTENSIONS.has(path.extname(name).toLowerCase()))
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }));
  } catch (err) {
    console.error(`[generate-demo-photos] Failed to read directory: ${demoPicsDir}`);
    console.error(err);
    return [];
  }
};

const toIdFromFilename = (filename) => {
  const base = path.basename(filename, path.extname(filename));
  const safe = base
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "");
  return `demo_person_${safe || "unknown"}`;
};

const main = async () => {
  const files = await getDemoFiles();

  const demoPhotos = files.map((filename) => {
    const url = `/assets/demo_pics/${filename}`;
    const id = toIdFromFilename(filename);
    return { url, id };
  });

  const header = `// THIS FILE IS AUTO-GENERATED by scripts/generate-demo-photos.mjs
// Do not edit manually. Add/remove images in public/assets/demo_pics instead.

`;

  const content =
    header +
    `export const DEMO_PHOTOS_ARRAY = ${JSON.stringify(demoPhotos, null, 2)} as const;

export const DEMO_PHOTO_ID_MAP = new Map<string, string>(
  (DEMO_PHOTOS_ARRAY as readonly { url: string; id: string }[]).map((photo) => [photo.url, photo.id]),
);
`;

  await fs.promises.mkdir(path.dirname(outFile), { recursive: true });
  await fs.promises.writeFile(outFile, content, "utf8");

  console.log(`[generate-demo-photos] Wrote ${demoPhotos.length} demo photos to ${outFile}`);
};

await main();


